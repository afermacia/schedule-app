<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Schedule</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;700&family=Golos+Text:wght@400;500;600&display=swap');

  :root {
    --bg: var(--tg-theme-bg-color, #0f0f0f);
    --bg2: var(--tg-theme-secondary-bg-color, #1a1a1a);
    --text: var(--tg-theme-text-color, #ffffff);
    --hint: var(--tg-theme-hint-color, #888888);
    --accent: var(--tg-theme-button-color, #3b82f6);
    --accent-text: var(--tg-theme-button-text-color, #ffffff);
    --border: rgba(255,255,255,0.08);
    --card: rgba(255,255,255,0.04);
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --radius: 16px;
    --font-display: 'Unbounded', sans-serif;
    --font-body: 'Golos Text', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 12px 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .topbar-title {
    font-family: var(--font-display);
    font-size: 13px; font-weight: 600;
    letter-spacing: 0.05em;
    flex: 1;
  }
  .btn-back {
    background: var(--card); border: 1px solid var(--border);
    color: var(--text); border-radius: 10px;
    padding: 6px 12px; font-size: 13px; cursor: pointer;
    font-family: var(--font-body);
    display: none; align-items: center; gap: 4px;
    transition: background 0.2s;
  }
  .btn-back:active { background: var(--border); }
  .btn-back.visible { display: flex; }

  /* ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ */
  .tabbar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    background: var(--bg);
    border-top: 1px solid var(--border);
    display: flex;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .tab {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; gap: 3px;
    padding: 10px 0;
    cursor: pointer;
    font-size: 10px; font-family: var(--font-body);
    color: var(--hint);
    transition: color 0.2s;
    border: none; background: none;
  }
  .tab.active { color: var(--accent); }
  .tab-icon { font-size: 20px; line-height: 1; }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen { display: none; padding: 16px 16px 90px; }
  .screen.active { display: block; }

  /* ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ */
  .month-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px;
  }
  .month-label {
    font-family: var(--font-display);
    font-size: 18px; font-weight: 600;
  }
  .nav-btn {
    background: var(--card); border: 1px solid var(--border);
    color: var(--text); border-radius: 10px;
    width: 36px; height: 36px;
    font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .nav-btn:active { background: var(--border); }

  .weeks-list { display: flex; flex-direction: column; gap: 10px; }
  .week-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 16px;
    cursor: pointer; transition: border-color 0.2s, transform 0.15s;
    display: flex; align-items: center; justify-content: space-between;
  }
  .week-card:active { transform: scale(0.98); }
  .week-card.current-week { border-color: var(--accent); }
  .week-card-left { display: flex; flex-direction: column; gap: 6px; }
  .week-num {
    font-family: var(--font-display);
    font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
    color: var(--hint); text-transform: uppercase;
  }
  .week-dates { font-size: 15px; font-weight: 600; }
  .week-mini-bar {
    display: flex; gap: 3px; margin-top: 4px;
  }
  .mini-day {
    width: 24px; height: 6px; border-radius: 3px;
    background: var(--border);
  }
  .mini-day.done { background: var(--success); }
  .mini-day.partial { background: var(--warning); }
  .mini-day.today-dot { background: var(--accent); }

  .week-pct {
    font-family: var(--font-display);
    font-size: 22px; font-weight: 700;
    color: var(--accent);
  }
  .week-pct span { font-size: 12px; color: var(--hint); font-family: var(--font-body); }

  /* ‚îÄ‚îÄ METRICS STRIP ‚îÄ‚îÄ */
  .metrics-strip {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 20px;
  }
  .metric-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 12px;
    text-align: center;
  }
  .metric-val {
    font-family: var(--font-display);
    font-size: 22px; font-weight: 700;
    line-height: 1;
  }
  .metric-label {
    font-size: 10px; color: var(--hint); margin-top: 4px;
    text-transform: uppercase; letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ WEEK VIEW ‚îÄ‚îÄ */
  .days-strip {
    display: flex; gap: 8px; overflow-x: auto;
    padding-bottom: 4px; margin-bottom: 16px;
    scrollbar-width: none;
  }
  .days-strip::-webkit-scrollbar { display: none; }
  .day-chip {
    flex-shrink: 0; display: flex; flex-direction: column;
    align-items: center; gap: 4px;
    padding: 10px 14px; border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--card); cursor: pointer;
    transition: all 0.2s;
    min-width: 54px;
  }
  .day-chip.selected {
    background: var(--accent); border-color: var(--accent);
    color: var(--accent-text);
  }
  .day-chip.today { border-color: var(--accent); }
  .day-chip-name {
    font-size: 10px; text-transform: uppercase;
    letter-spacing: 0.08em; font-weight: 600;
  }
  .day-chip-num {
    font-family: var(--font-display); font-size: 18px; font-weight: 700;
  }
  .day-chip-dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--success);
  }
  .day-chip.selected .day-chip-dot { background: white; }

  /* ‚îÄ‚îÄ DAY TASKS ‚îÄ‚îÄ */
  .section-label {
    font-family: var(--font-display);
    font-size: 11px; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--hint);
    margin-bottom: 10px;
  }

  .tasks-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .task-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 12px 14px;
    display: flex; align-items: center; gap: 12px;
    transition: border-color 0.2s;
  }
  .task-item.done { opacity: 0.6; }
  .task-item.done .task-text { text-decoration: line-through; }
  .task-checkbox {
    width: 22px; height: 22px; border-radius: 7px;
    border: 2px solid var(--border); flex-shrink: 0;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; font-size: 12px;
  }
  .task-item.done .task-checkbox {
    background: var(--success); border-color: var(--success); color: white;
  }
  .task-text { flex: 1; font-size: 14px; line-height: 1.4; }
  .task-time { font-size: 12px; color: var(--hint); }
  .task-del {
    background: none; border: none; color: var(--hint);
    cursor: pointer; font-size: 16px; padding: 4px;
    border-radius: 6px; transition: color 0.2s;
  }
  .task-del:active { color: var(--danger); }

  /* ‚îÄ‚îÄ ADD TASK ‚îÄ‚îÄ */
  .add-task-bar {
    display: flex; gap: 8px; margin-bottom: 20px;
  }
  .add-task-input {
    flex: 1; background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 14px;
    color: var(--text); font-size: 14px; font-family: var(--font-body);
    outline: none; transition: border-color 0.2s;
  }
  .add-task-input:focus { border-color: var(--accent); }
  .add-task-input::placeholder { color: var(--hint); }
  .btn-add {
    background: var(--accent); color: var(--accent-text);
    border: none; border-radius: 12px;
    padding: 12px 16px; font-size: 20px; cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn-add:active { opacity: 0.8; }

  /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
  .progress-wrap { margin-bottom: 20px; }
  .progress-track {
    height: 6px; background: var(--border);
    border-radius: 3px; overflow: hidden;
  }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 3px; transition: width 0.5s ease;
  }
  .progress-label {
    display: flex; justify-content: space-between;
    font-size: 12px; color: var(--hint); margin-top: 6px;
  }

  /* ‚îÄ‚îÄ AI CHAT ‚îÄ‚îÄ */
  .ai-messages {
    display: flex; flex-direction: column; gap: 10px;
    margin-bottom: 16px; min-height: 200px;
    max-height: 55vh; overflow-y: auto;
    scrollbar-width: thin;
  }
  .msg {
    max-width: 85%; padding: 10px 14px;
    border-radius: 16px; font-size: 14px; line-height: 1.5;
    animation: fadeUp 0.3s ease;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .msg.ai {
    background: var(--card); border: 1px solid var(--border);
    border-bottom-left-radius: 4px; align-self: flex-start;
  }
  .msg.user {
    background: var(--accent); color: var(--accent-text);
    border-bottom-right-radius: 4px; align-self: flex-end;
  }
  .msg.loading { color: var(--hint); font-style: italic; }

  .ai-input-bar {
    display: flex; gap: 8px; position: sticky; bottom: 80px;
  }
  .ai-input {
    flex: 1; background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; padding: 12px 14px;
    color: var(--text); font-size: 14px; font-family: var(--font-body);
    outline: none; transition: border-color 0.2s; resize: none;
    max-height: 100px; min-height: 44px;
  }
  .ai-input:focus { border-color: var(--accent); }
  .ai-input::placeholder { color: var(--hint); }
  .btn-send {
    background: var(--accent); color: var(--accent-text);
    border: none; border-radius: 14px;
    width: 44px; font-size: 18px; cursor: pointer;
    transition: opacity 0.2s; flex-shrink: 0;
  }
  .btn-send:active { opacity: 0.8; }
  .btn-send:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ STATS SCREEN ‚îÄ‚îÄ */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
  .stat-big {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
  }
  .stat-big.full { grid-column: 1 / -1; }
  .stat-big-val {
    font-family: var(--font-display); font-size: 28px; font-weight: 700;
    color: var(--accent);
  }
  .stat-big-label { font-size: 12px; color: var(--hint); margin-top: 4px; }
  .streak-fire { font-size: 24px; }

  .week-chart { display: flex; align-items: flex-end; gap: 6px; height: 80px; margin-top: 12px; }
  .bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; }
  .bar-track { flex: 1; width: 100%; background: var(--border); border-radius: 4px; display: flex; align-items: flex-end; overflow: hidden; }
  .bar-fill { width: 100%; background: linear-gradient(180deg, var(--accent), var(--success)); border-radius: 4px; transition: height 0.5s ease; }
  .bar-day { font-size: 10px; color: var(--hint); }

  .empty-state {
    text-align: center; padding: 40px 20px; color: var(--hint);
  }
  .empty-icon { font-size: 40px; margin-bottom: 10px; }
  .empty-text { font-size: 14px; }

  /* ‚îÄ‚îÄ CHIP SUGGESTIONS ‚îÄ‚îÄ */
  .ai-chips {
    display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
  }
  .ai-chip {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 12px;
    font-size: 12px; cursor: pointer; transition: all 0.2s;
    color: var(--text);
  }
  .ai-chip:active { background: var(--accent); color: var(--accent-text); border-color: var(--accent); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="btn-back" id="btnBack" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
  <div class="topbar-title" id="topbarTitle">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
</div>

<!-- SCREEN: MONTH -->
<div class="screen active" id="screenMonth">
  <div class="month-header">
    <button class="nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
    <div class="month-label" id="monthLabel"></div>
    <button class="nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
  </div>

  <div class="metrics-strip">
    <div class="metric-card">
      <div class="metric-val" id="mStreak" style="color:var(--warning)">üî• 0</div>
      <div class="metric-label">Streak</div>
    </div>
    <div class="metric-card">
      <div class="metric-val" id="mDone" style="color:var(--success)">0</div>
      <div class="metric-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="metric-card">
      <div class="metric-val" id="mPct" style="color:var(--accent)">0%</div>
      <div class="metric-label">–ü—Ä–æ–¥—É–∫—Ç.</div>
    </div>
  </div>

  <div class="section-label">–ù–µ–¥–µ–ª–∏ –º–µ—Å—è—Ü–∞</div>
  <div class="weeks-list" id="weeksList"></div>
</div>

<!-- SCREEN: WEEK -->
<div class="screen" id="screenWeek">
  <div class="days-strip" id="daysStrip"></div>
  <div class="progress-wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="section-label" style="margin:0">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</div>
      <div id="dayPctLabel" style="font-family:var(--font-display);font-size:14px;font-weight:700;color:var(--accent)">0%</div>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>

  <div class="section-label">–ó–∞–¥–∞—á–∏</div>
  <div class="tasks-list" id="tasksList"></div>

  <div class="add-task-bar">
    <input class="add-task-input" id="newTaskInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É..." maxlength="100"
      onkeydown="if(event.key==='Enter')addTask()">
    <button class="btn-add" onclick="addTask()">+</button>
  </div>
</div>

<!-- SCREEN: AI -->
<div class="screen" id="screenAI">
  <div class="ai-messages" id="aiMessages">
    <div class="msg ai">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ü§ñ –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–∞–¥–∞—á, –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã. –ß—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å?</div>
  </div>
  <div class="ai-chips" id="aiChips">
    <div class="ai-chip" onclick="sendChip(this)">üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å</div>
    <div class="ai-chip" onclick="sendChip(this)">‚úÖ –ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏</div>
    <div class="ai-chip" onclick="sendChip(this)">üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
  </div>
  <div class="ai-input-bar">
    <textarea class="ai-input" id="aiInput" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
      oninput="autoResize(this)"></textarea>
    <button class="btn-send" id="btnSend" onclick="sendMessage()">‚Üë</button>
  </div>
</div>

<!-- SCREEN: STATS -->
<div class="screen" id="screenStats">
  <div class="stats-grid">
    <div class="stat-big">
      <div class="stat-big-val"><span class="streak-fire">üî•</span> <span id="statStreak">0</span></div>
      <div class="stat-big-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
    </div>
    <div class="stat-big">
      <div class="stat-big-val" id="statTotalDone" style="color:var(--success)">0</div>
      <div class="stat-big-label">–ó–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="stat-big">
      <div class="stat-big-val" id="statAvgPct" style="color:var(--accent)">0%</div>
      <div class="stat-big-label">–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥—É–∫—Ç.</div>
    </div>
    <div class="stat-big">
      <div class="stat-big-val" id="statBestDay" style="color:var(--warning)">‚Äî</div>
      <div class="stat-big-label">–õ—É—á—à–∏–π –¥–µ–Ω—å</div>
    </div>
    <div class="stat-big full">
      <div class="section-label">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è –ø–æ –¥–Ω—è–º</div>
      <div class="week-chart" id="weekChart"></div>
    </div>
  </div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <button class="tab active" onclick="switchTab(0)" id="tab0">
    <div class="tab-icon">üìÖ</div>
    <div>–ú–µ—Å—è—Ü</div>
  </button>
  <button class="tab" onclick="switchTab(1)" id="tab1">
    <div class="tab-icon">üìã</div>
    <div>–ù–µ–¥–µ–ª—è</div>
  </button>
  <button class="tab" onclick="switchTab(2)" id="tab2">
    <div class="tab-icon">ü§ñ</div>
    <div>AI</div>
  </button>
  <button class="tab" onclick="switchTab(3)" id="tab3">
    <div class="tab-icon">üìà</div>
    <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  </button>
</div>

<script>
// ‚îÄ‚îÄ TELEGRAM INIT ‚îÄ‚îÄ
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let state = {
  viewMonth: new Date().getMonth(),
  viewYear: new Date().getFullYear(),
  selectedWeek: null,  // {start: Date, end: Date}
  selectedDay: null,   // Date string YYYY-MM-DD
  tasks: {},           // { 'YYYY-MM-DD': [{id, text, done}] }
  streak: 0,
  lastActiveDay: null,
};

// Load from localStorage
try {
  const saved = JSON.parse(localStorage.getItem('scheduleData') || '{}');
  if (saved.tasks) state.tasks = saved.tasks;
  if (saved.streak !== undefined) state.streak = saved.streak;
  if (saved.lastActiveDay) state.lastActiveDay = saved.lastActiveDay;
} catch(e) {}

function save() {
  localStorage.setItem('scheduleData', JSON.stringify({
    tasks: state.tasks,
    streak: state.streak,
    lastActiveDay: state.lastActiveDay,
  }));
}

// ‚îÄ‚îÄ DATE UTILS ‚îÄ‚îÄ
const DAYS_RU = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
const DAYS_FULL = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const MONTHS_RU = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const MONTHS_GEN = ['–Ø–Ω–≤–∞—Ä—è','–§–µ–≤—Ä–∞–ª—è','–ú–∞—Ä—Ç–∞','–ê–ø—Ä–µ–ª—è','–ú–∞—è','–ò—é–Ω—è','–ò—é–ª—è','–ê–≤–≥—É—Å—Ç–∞','–°–µ–Ω—Ç—è–±—Ä—è','–û–∫—Ç—è–±—Ä—è','–ù–æ—è–±—Ä—è','–î–µ–∫–∞–±—Ä—è'];

function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function todayKey() { return dateKey(new Date()); }

function getDayPct(dayKey) {
  const tasks = state.tasks[dayKey] || [];
  if (!tasks.length) return 0;
  return Math.round(tasks.filter(t=>t.done).length / tasks.length * 100);
}

function getWeeksOfMonth(year, month) {
  const weeks = [];
  // Monday-based weeks
  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);
  let cur = new Date(first);
  // Go back to Monday
  let dow = cur.getDay(); // 0=Sun
  let offset = (dow === 0) ? 6 : dow - 1;
  cur.setDate(cur.getDate() - offset);
  while (cur <= last) {
    const wStart = new Date(cur);
    const wEnd = new Date(cur); wEnd.setDate(wEnd.getDate() + 6);
    weeks.push({ start: new Date(wStart), end: new Date(wEnd) });
    cur.setDate(cur.getDate() + 7);
  }
  return weeks;
}

function getDaysOfWeek(start) {
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(start); d.setDate(d.getDate() + i);
    days.push(d);
  }
  return days;
}

// ‚îÄ‚îÄ STREAK CALC ‚îÄ‚îÄ
function calcStreak() {
  const today = todayKey();
  let streak = 0;
  let cur = new Date();
  // check today or yesterday
  for (let i = 0; i < 365; i++) {
    const key = dateKey(cur);
    const tasks = state.tasks[key] || [];
    const done = tasks.filter(t=>t.done).length;
    if (done > 0 && tasks.length > 0) {
      streak++;
    } else {
      if (i === 0) { cur.setDate(cur.getDate()-1); continue; } // skip today if not done yet
      break;
    }
    cur.setDate(cur.getDate()-1);
  }
  return streak;
}

// ‚îÄ‚îÄ MONTH SCREEN ‚îÄ‚îÄ
function renderMonth() {
  const { viewYear, viewMonth } = state;
  document.getElementById('monthLabel').textContent = `${MONTHS_RU[viewMonth]} ${viewYear}`;
  const weeks = getWeeksOfMonth(viewYear, viewMonth);
  const todayD = new Date(); todayD.setHours(0,0,0,0);

  // Metrics
  let totalDone = 0, totalTasks = 0;
  weeks.forEach(w => {
    getDaysOfWeek(w.start).forEach(d => {
      const key = dateKey(d);
      const tasks = state.tasks[key] || [];
      totalDone += tasks.filter(t=>t.done).length;
      totalTasks += tasks.length;
    });
  });
  const streak = calcStreak();
  document.getElementById('mStreak').textContent = `üî• ${streak}`;
  document.getElementById('mDone').textContent = totalDone;
  document.getElementById('mPct').textContent = totalTasks ? Math.round(totalDone/totalTasks*100)+'%' : '0%';

  const container = document.getElementById('weeksList');
  container.innerHTML = '';
  weeks.forEach((w, i) => {
    const days = getDaysOfWeek(w.start);
    const isCurrentWeek = days.some(d => { const dd = new Date(d); dd.setHours(0,0,0,0); return dd.getTime() === todayD.getTime(); });
    let wDone = 0, wTotal = 0;
    const miniDots = days.map(d => {
      const key = dateKey(d); const tasks = state.tasks[key]||[];
      const done = tasks.filter(t=>t.done).length;
      wDone += done; wTotal += tasks.length;
      const dd = new Date(d); dd.setHours(0,0,0,0);
      const isToday = dd.getTime() === todayD.getTime();
      let cls = '';
      if (isToday) cls = 'today-dot';
      else if (!tasks.length) cls = '';
      else if (done === tasks.length) cls = 'done';
      else if (done > 0) cls = 'partial';
      return `<div class="mini-day ${cls}"></div>`;
    }).join('');
    const pct = wTotal ? Math.round(wDone/wTotal*100) : 0;

    const fmtDate = (d) => `${d.getDate()} ${MONTHS_GEN[d.getMonth()]}`;
    const card = document.createElement('div');
    card.className = `week-card${isCurrentWeek?' current-week':''}`;
    card.innerHTML = `
      <div class="week-card-left">
        <div class="week-num">–ù–µ–¥–µ–ª—è ${i+1}</div>
        <div class="week-dates">${fmtDate(w.start)} ‚Äî ${fmtDate(w.end)}</div>
        <div class="week-mini-bar">${miniDots}</div>
      </div>
      <div class="week-pct">${pct}<span>%</span></div>`;
    card.onclick = () => openWeek(w);
    container.appendChild(card);
  });
}

function changeMonth(dir) {
  state.viewMonth += dir;
  if (state.viewMonth > 11) { state.viewMonth = 0; state.viewYear++; }
  if (state.viewMonth < 0) { state.viewMonth = 11; state.viewYear--; }
  renderMonth();
}

// ‚îÄ‚îÄ WEEK SCREEN ‚îÄ‚îÄ
function openWeek(week) {
  state.selectedWeek = week;
  const days = getDaysOfWeek(week.start);
  // Default to today if in week, else first day
  const todayKey_ = todayKey();
  const todayInWeek = days.find(d => dateKey(d) === todayKey_);
  state.selectedDay = todayInWeek ? todayKey_ : dateKey(days[0]);
  renderWeek();
  switchTab(1);
}

function renderWeek() {
  if (!state.selectedWeek) {
    // Auto select current week
    const now = new Date();
    const weeks = getWeeksOfMonth(now.getFullYear(), now.getMonth());
    const todayD = new Date(); todayD.setHours(0,0,0,0);
    const cw = weeks.find(w => getDaysOfWeek(w.start).some(d => { const dd=new Date(d); dd.setHours(0,0,0,0); return dd.getTime()===todayD.getTime(); }));
    state.selectedWeek = cw || weeks[0];
    state.selectedDay = todayKey();
  }
  const days = getDaysOfWeek(state.selectedWeek.start);
  const strip = document.getElementById('daysStrip');
  strip.innerHTML = '';
  const todayD = new Date(); todayD.setHours(0,0,0,0);
  days.forEach(d => {
    const key = dateKey(d);
    const dd = new Date(d); dd.setHours(0,0,0,0);
    const isToday = dd.getTime() === todayD.getTime();
    const isSelected = key === state.selectedDay;
    const tasks = state.tasks[key]||[];
    const hasDone = tasks.some(t=>t.done);
    const chip = document.createElement('div');
    chip.className = `day-chip${isSelected?' selected':''}${isToday&&!isSelected?' today':''}`;
    chip.innerHTML = `
      <div class="day-chip-name">${DAYS_RU[d.getDay()]}</div>
      <div class="day-chip-num">${d.getDate()}</div>
      ${hasDone ? '<div class="day-chip-dot"></div>' : '<div style="height:5px"></div>'}`;
    chip.onclick = () => selectDay(key);
    strip.appendChild(chip);
  });
  renderTasks();

  // Update topbar
  if (state.selectedWeek) {
    const s = state.selectedWeek.start, e = state.selectedWeek.end;
    document.getElementById('topbarTitle').textContent =
      `${s.getDate()} ${MONTHS_GEN[s.getMonth()]} ‚Äî ${e.getDate()} ${MONTHS_GEN[e.getMonth()]}`;
  }
}

function selectDay(key) {
  state.selectedDay = key;
  renderWeek();
}

function renderTasks() {
  const key = state.selectedDay || todayKey();
  const tasks = state.tasks[key] || [];
  const list = document.getElementById('tasksList');
  list.innerHTML = '';

  if (!tasks.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">–ó–∞–¥–∞—á –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é!</div></div>';
  } else {
    tasks.forEach((task, i) => {
      const item = document.createElement('div');
      item.className = `task-item${task.done?' done':''}`;
      item.innerHTML = `
        <div class="task-checkbox" onclick="toggleTask('${key}', ${i})">${task.done?'‚úì':''}</div>
        <div class="task-text">${escapeHtml(task.text)}</div>
        <button class="task-del" onclick="deleteTask('${key}', ${i})">√ó</button>`;
      list.appendChild(item);
    });
  }

  // Progress
  const pct = getDayPct(key);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('dayPctLabel').textContent = pct + '%';
}

function addTask() {
  const input = document.getElementById('newTaskInput');
  const text = input.value.trim();
  if (!text) return;
  const key = state.selectedDay || todayKey();
  if (!state.tasks[key]) state.tasks[key] = [];
  state.tasks[key].push({ id: Date.now(), text, done: false });
  input.value = '';
  save();
  renderTasks();
  renderWeek(); // update dots
}

function toggleTask(key, idx) {
  if (!state.tasks[key]) return;
  state.tasks[key][idx].done = !state.tasks[key][idx].done;
  save();
  renderTasks();
  renderWeek();
  renderMonth();
}

function deleteTask(key, idx) {
  if (!state.tasks[key]) return;
  state.tasks[key].splice(idx, 1);
  save();
  renderTasks();
  renderWeek();
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ AI SCREEN ‚îÄ‚îÄ
let aiLoading = false;

function buildContext() {
  const today = todayKey();
  const todayTasks = state.tasks[today] || [];
  const streak = calcStreak();
  let ctx = `–°–µ–≥–æ–¥–Ω—è: ${today}. Streak: ${streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥.\n`;
  ctx += `–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n`;
  if (todayTasks.length) {
    todayTasks.forEach(t => { ctx += `- [${t.done?'X':' '}] ${t.text}\n`; });
  } else {
    ctx += '- –Ω–µ—Ç –∑–∞–¥–∞—á\n';
  }
  const pct = getDayPct(today);
  ctx += `–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è: ${pct}%\n`;
  return ctx;
}

async function sendMessage() {
  if (aiLoading) return;
  const input = document.getElementById('aiInput');
  const text = input.value.trim();
  if (!text) return;
  addMsg(text, 'user');
  input.value = '';
  input.style.height = 'auto';
  await callAI(text);
}

function sendChip(el) {
  const text = el.textContent.replace(/^[^\s]+ /, '').trim();
  document.getElementById('aiInput').value = el.textContent;
  // Actually just send it
  const fullText = el.textContent;
  addMsg(fullText, 'user');
  callAI(fullText);
}

function addMsg(text, role) {
  const msgs = document.getElementById('aiMessages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

async function callAI(userMsg) {
  aiLoading = true;
  document.getElementById('btnSend').disabled = true;
  const loadDiv = addMsg('–î—É–º–∞—é‚Ä¶', 'ai loading');

  const context = buildContext();
  const systemPrompt = `–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ Telegram Mini App "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ". 
–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
${context}
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ü–æ–º–æ–≥–∞–π —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–∞–¥–∞—á, –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å–æ–≤–µ—Ç–∞–º–∏. –ù–µ –ø—Ä–µ–≤—ã—à–∞–π 200 —Å–ª–æ–≤.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMsg }]
      })
    });
    const data = await res.json();
    const reply = data.content?.[0]?.text || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç';
    loadDiv.textContent = reply;
    loadDiv.classList.remove('loading');
  } catch(e) {
    loadDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
  }
  aiLoading = false;
  document.getElementById('btnSend').disabled = false;
  document.getElementById('aiMessages').scrollTop = 9999;
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// ‚îÄ‚îÄ STATS SCREEN ‚îÄ‚îÄ
function renderStats() {
  const streak = calcStreak();
  document.getElementById('statStreak').textContent = streak;

  let totalDone = 0, totalTasks = 0, bestDay = null, bestPct = 0;
  const days = Object.keys(state.tasks);
  days.forEach(key => {
    const tasks = state.tasks[key]||[];
    const done = tasks.filter(t=>t.done).length;
    totalDone += done; totalTasks += tasks.length;
    const pct = tasks.length ? done/tasks.length*100 : 0;
    if (pct > bestPct && tasks.length > 0) { bestPct = pct; bestDay = key; }
  });
  document.getElementById('statTotalDone').textContent = totalDone;
  document.getElementById('statAvgPct').textContent = totalTasks ? Math.round(totalDone/totalTasks*100)+'%' : '0%';
  if (bestDay) {
    const d = new Date(bestDay+'T12:00:00');
    document.getElementById('statBestDay').textContent = `${d.getDate()} ${MONTHS_GEN[d.getMonth()]}`;
  }

  // Week chart
  const chart = document.getElementById('weekChart');
  chart.innerHTML = '';
  const now = new Date();
  // Current week Mon-Sun
  const dow = now.getDay(); const offset = dow===0?6:dow-1;
  const mon = new Date(now); mon.setDate(mon.getDate()-offset);
  for (let i=0; i<7; i++) {
    const d = new Date(mon); d.setDate(d.getDate()+i);
    const key = dateKey(d);
    const pct = getDayPct(key);
    const wrap = document.createElement('div');
    wrap.className = 'bar-wrap';
    wrap.innerHTML = `
      <div class="bar-track"><div class="bar-fill" style="height:${pct}%"></div></div>
      <div class="bar-day">${DAYS_RU[(d.getDay())]}</div>`;
    chart.appendChild(wrap);
  }
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
const screens = ['screenMonth','screenWeek','screenAI','screenStats'];
const tabs = ['tab0','tab1','tab2','tab3'];
let currentTab = 0;

function switchTab(idx) {
  screens.forEach((s,i) => {
    document.getElementById(s).classList.toggle('active', i===idx);
    document.getElementById(tabs[i]).classList.toggle('active', i===idx);
  });
  currentTab = idx;
  document.getElementById('btnBack').classList.toggle('visible', false);
  if (idx === 0) { document.getElementById('topbarTitle').textContent='–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ'; renderMonth(); }
  if (idx === 1) { renderWeek(); }
  if (idx === 2) { document.getElementById('topbarTitle').textContent='AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'; }
  if (idx === 3) { document.getElementById('topbarTitle').textContent='–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'; renderStats(); }
}

function goBack() {
  switchTab(0);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
renderMonth();
// Auto-open current week on week tab
const nowW = new Date();
const weeks = getWeeksOfMonth(nowW.getFullYear(), nowW.getMonth());
const todayD2 = new Date(); todayD2.setHours(0,0,0,0);
state.selectedWeek = weeks.find(w =>
  getDaysOfWeek(w.start).some(d => { const dd=new Date(d); dd.setHours(0,0,0,0); return dd.getTime()===todayD2.getTime(); })
) || weeks[0];
state.selectedDay = todayKey();
</script>
</body>
</html>
