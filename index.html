<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Schedule</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;700&family=Golos+Text:wght@400;500;600&display=swap');
:root {
  --bg: var(--tg-theme-bg-color, #0f0f0f);
  --bg2: var(--tg-theme-secondary-bg-color, #1c1c1e);
  --text: var(--tg-theme-text-color, #ffffff);
  --hint: var(--tg-theme-hint-color, #8e8e93);
  --accent: var(--tg-theme-button-color, #3b82f6);
  --accent-text: var(--tg-theme-button-text-color, #ffffff);
  --border: rgba(255,255,255,0.08);
  --card: rgba(255,255,255,0.04);
  --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
  --radius: 16px;
  --font-d: 'Unbounded', sans-serif;
  --font-b: 'Golos Text', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;overflow-x:hidden;}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:8px;}
.topbar-title{font-family:var(--font-d);font-size:12px;font-weight:600;letter-spacing:.05em;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btn-ic{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:10px;width:34px;height:34px;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0;}
.btn-ic:active{background:var(--border);}

/* TABBAR */
.tabbar{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--bg);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom);}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 0;cursor:pointer;font-size:9px;color:var(--hint);transition:color .2s;border:none;background:none;}
.tab.active{color:var(--accent);}
.tab-icon{font-size:18px;line-height:1;}

/* SCREENS */
.screen{display:none;padding:0 0 90px;}
.screen.active{display:block;}

/* SHARED */
.slbl{font-family:var(--font-d);font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--hint);margin-bottom:10px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;}

/* MONTH */
.m-inner{padding:16px;}
.month-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.month-lbl{font-family:var(--font-d);font-size:17px;font-weight:700;}
.metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px;}
.mc{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 10px;text-align:center;}
.mc-val{font-family:var(--font-d);font-size:20px;font-weight:700;line-height:1;}
.mc-lbl{font-size:9px;color:var(--hint);margin-top:4px;text-transform:uppercase;letter-spacing:.06em;}

/* HEATMAP */
.heatmap-wrap{margin-bottom:20px;}
.heatmap-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:8px;}
.hm-cell{aspect-ratio:1;border-radius:4px;cursor:pointer;transition:transform .15s;}
.hm-cell:active{transform:scale(.85);}
.hm-0{background:var(--border);}
.hm-1{background:rgba(34,197,94,.25);}
.hm-2{background:rgba(34,197,94,.50);}
.hm-3{background:rgba(34,197,94,.75);}
.hm-4{background:rgba(34,197,94,1);}
.hm-today{outline:2px solid var(--accent);outline-offset:1px;}
.hm-days-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;}
.hm-day-lbl{font-size:9px;color:var(--hint);text-align:center;}

.wlist{display:flex;flex-direction:column;gap:8px;}
.wcard{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between;}
.wcard.cw{border-color:var(--accent);}
.wcard:active{transform:scale(.98);}
.wnum{font-family:var(--font-d);font-size:10px;font-weight:600;letter-spacing:.08em;color:var(--hint);text-transform:uppercase;}
.wdates{font-size:14px;font-weight:600;margin:3px 0;}
.wmbar{display:flex;gap:3px;}
.md{width:22px;height:5px;border-radius:3px;background:var(--border);}
.md.done{background:var(--success);}.md.partial{background:var(--warning);}.md.today{background:var(--accent);}
.wpct{font-family:var(--font-d);font-size:20px;font-weight:700;color:var(--accent);}
.wpct span{font-size:11px;color:var(--hint);font-family:var(--font-b);}

/* WEEK NAV */
.week-nav{display:flex;align-items:center;padding:10px 16px 0;gap:8px;}
.week-nav-lbl{font-family:var(--font-d);font-size:11px;font-weight:600;color:var(--hint);letter-spacing:.04em;flex:1;text-align:center;}

/* DAY STRIP */
.dstrip{display:flex;gap:6px;overflow-x:auto;padding:10px 16px 8px;scrollbar-width:none;}
.dstrip::-webkit-scrollbar{display:none;}
.dchip{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);cursor:pointer;transition:all .2s;min-width:50px;}
.dchip.sel{background:var(--accent);border-color:var(--accent);color:var(--accent-text);}
.dchip.tod{border-color:var(--accent);}
.dchip-n{font-size:9px;text-transform:uppercase;letter-spacing:.08em;font-weight:600;}
.dchip-d{font-family:var(--font-d);font-size:17px;font-weight:700;}
.dchip-dot{width:4px;height:4px;border-radius:50%;background:var(--success);}
.dchip.sel .dchip-dot{background:white;}

/* TIME GRID */
.tgwrap{overflow-y:auto;position:relative;padding:0 12px 16px;}
.tgrid{position:relative;}

/* TASK BLOCKS */
.tblock{position:absolute;border-radius:10px;padding:5px 8px;cursor:pointer;overflow:hidden;display:flex;align-items:flex-start;gap:5px;border-left-width:3px;border-left-style:solid;border-top:1px solid rgba(255,255,255,.1);border-right:1px solid rgba(255,255,255,.1);border-bottom:1px solid rgba(255,255,255,.1);z-index:5;user-select:none;}
.tblock.dragging{opacity:.7;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.5);transform:scale(1.02);}
.tblock.done-block{opacity:.45;}
.tblock.done-block .tbtitle{text-decoration:line-through;}
.tbbody{flex:1;min-width:0;}
.tbtitle{font-size:11px;font-weight:600;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tbtime{font-size:9px;opacity:.7;margin-top:1px;}
.tchk{width:16px;height:16px;border-radius:5px;border:2px solid rgba(255,255,255,.4);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;margin-top:2px;transition:all .2s;}
.tchk.ck{background:rgba(255,255,255,.3);border-color:transparent;}

/* QUICK ADD â€” tap on timeslot */
.slot-add-hint{position:absolute;left:52px;right:4px;border-radius:8px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--hint);font-size:11px;cursor:pointer;transition:all .2s;z-index:3;}
.slot-add-hint:hover,.slot-add-hint:active{border-color:var(--accent);color:var(--accent);}

/* FAB */
.fab{position:fixed;bottom:80px;right:16px;z-index:50;width:50px;height:50px;border-radius:50%;background:var(--accent);color:var(--accent-text);border:none;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;transition:transform .2s;}
.fab:active{transform:scale(.9);}

/* MODAL */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:flex-end;backdrop-filter:blur(6px);}
.moverlay.open{display:flex;}
.modal{background:var(--bg2);border-radius:24px 24px 0 0;padding:20px 20px 40px;width:100%;max-height:92vh;overflow-y:auto;animation:slideUp .28s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px;}
.mtitle{font-family:var(--font-d);font-size:14px;font-weight:600;margin-bottom:18px;}
.ig{margin-bottom:13px;}
.ilbl{font-size:10px;color:var(--hint);text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px;}
.inp{width:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:11px 13px;color:var(--text);font-size:14px;font-family:var(--font-b);outline:none;transition:border-color .2s;}
.inp:focus{border-color:var(--accent);}
.inp::placeholder{color:var(--hint);}
textarea.inp{resize:none;min-height:72px;}
select.inp{appearance:none;}
.tinputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.ai-icon-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;min-height:34px;align-items:center;}
.ai-ic-btn{background:var(--accent);color:var(--accent-text);border:none;border-radius:18px;padding:5px 10px;font-size:17px;cursor:pointer;}
.ai-ic-btn.sel{box-shadow:0 0 0 2px white;}
.ai-ic-hint,.ai-ic-load{font-size:11px;color:var(--hint);}
.igrid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;max-height:180px;overflow-y:auto;}
.iopt{font-size:20px;padding:7px;border-radius:9px;cursor:pointer;text-align:center;background:var(--card);border:1px solid var(--border);}
.iopt.sel{background:var(--accent);border-color:var(--accent);}
.crow{display:flex;gap:7px;flex-wrap:wrap;}
.copt{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .15s;}
.copt.sel{border-color:var(--text);transform:scale(1.15);}
.btnrow{display:flex;gap:8px;margin-top:14px;}
.btnp{flex:1;background:var(--accent);color:var(--accent-text);border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font-b);}
.btns{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:13px;padding:13px 14px;font-size:14px;cursor:pointer;font-family:var(--font-b);}
.btnd{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.2);border-radius:13px;padding:13px 14px;font-size:14px;cursor:pointer;font-family:var(--font-b);}

/* REPEAT PILLS */
.repeat-pills{display:flex;gap:6px;flex-wrap:wrap;}
.rpill{padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;background:var(--card);border:1px solid var(--border);color:var(--text);transition:all .15s;}
.rpill.sel{background:var(--accent);border-color:var(--accent);color:var(--accent-text);}
.repeat-days{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.rday{width:34px;height:34px;border-radius:50%;font-size:11px;font-weight:600;cursor:pointer;background:var(--card);border:1px solid var(--border);color:var(--text);display:flex;align-items:center;justify-content:center;transition:all .15s;}
.rday.sel{background:var(--accent);border-color:var(--accent);color:var(--accent-text);}

/* CATEGORY BADGE */
.cat-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;}

/* DETAIL */
.det-hdr{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
.det-icon{font-size:34px;}
.det-info{flex:1;}
.det-title{font-family:var(--font-d);font-size:15px;font-weight:600;}
.det-time{font-size:13px;color:var(--hint);margin-top:3px;}
.det-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;margin-top:6px;}

/* AI */
.ai-inner{padding:16px;}
.ai-msgs{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;min-height:150px;max-height:50vh;overflow-y:auto;}
.msg{max-width:86%;padding:10px 13px;border-radius:16px;font-size:13px;line-height:1.5;animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.ai{background:var(--card);border:1px solid var(--border);border-bottom-left-radius:4px;align-self:flex-start;}
.msg.user{background:var(--accent);color:var(--accent-text);border-bottom-right-radius:4px;align-self:flex-end;}
.msg.loading{color:var(--hint);font-style:italic;}
.msg-img{max-width:220px;border-radius:10px;display:block;margin-top:5px;}
.img-previews{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;}
.img-preview-wrap{position:relative;}
.img-preview{width:58px;height:58px;object-fit:cover;border-radius:9px;border:1px solid var(--border);}
.img-preview-del{position:absolute;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--danger);color:white;border:none;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.ai-ibar{display:flex;gap:7px;align-items:flex-end;}
.ai-inp{flex:1;background:var(--card);border:1px solid var(--border);border-radius:13px;padding:11px 13px;color:var(--text);font-size:13px;font-family:var(--font-b);outline:none;resize:none;max-height:90px;min-height:42px;}
.ai-inp:focus{border-color:var(--accent);}
.ai-inp::placeholder{color:var(--hint);}
.btn-snd{background:var(--accent);color:var(--accent-text);border:none;border-radius:13px;width:42px;height:42px;font-size:17px;cursor:pointer;flex-shrink:0;}
.btn-snd:disabled{opacity:.4;}
.btn-img-attach{background:var(--card);border:1px solid var(--border);color:var(--hint);border-radius:13px;width:42px;height:42px;font-size:17px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.ai-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.ai-chip{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:5px 11px;font-size:11px;cursor:pointer;color:var(--text);}
.ai-chip:active{background:var(--accent);color:var(--accent-text);border-color:var(--accent);}

/* STATS */
.st-inner{padding:16px;}
.st-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.stb{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;}
.stb.full{grid-column:1/-1;}
.stbv{font-family:var(--font-d);font-size:26px;font-weight:700;color:var(--accent);}
.stbl{font-size:11px;color:var(--hint);margin-top:3px;}
.wchart{display:flex;align-items:flex-end;gap:5px;height:72px;margin-top:10px;}
.bwrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%;}
.btrack{flex:1;width:100%;background:var(--border);border-radius:4px;display:flex;align-items:flex-end;overflow:hidden;}
.bfill{width:100%;background:linear-gradient(180deg,var(--accent),var(--success));border-radius:4px;transition:height .5s ease;}
.bday{font-size:9px;color:var(--hint);}

/* CATEGORIES PIE-LIKE */
.cat-bars{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.cat-bar-row{display:flex;align-items:center;gap:8px;}
.cat-bar-label{font-size:12px;width:80px;flex-shrink:0;display:flex;align-items:center;gap:5px;}
.cat-bar-track{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;}
.cat-bar-fill{height:100%;border-radius:4px;transition:width .5s;}
.cat-bar-val{font-size:11px;color:var(--hint);width:36px;text-align:right;flex-shrink:0;}

/* HOURS TABLE */
.hours-week-nav{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.hours-week-lbl{flex:1;text-align:center;font-family:var(--font-d);font-size:11px;font-weight:600;}
.hours-table{width:100%;border-collapse:collapse;}
.hours-table th{font-size:9px;color:var(--hint);text-transform:uppercase;letter-spacing:.06em;padding:5px 6px;text-align:left;font-family:var(--font-d);font-weight:600;}
.hours-table td{padding:8px 6px;border-top:1px solid var(--border);font-size:12px;vertical-align:middle;}
.hours-table td:first-child{width:28px;}
.fact-bar-wrap{display:flex;align-items:center;gap:6px;margin-top:3px;}
.fact-bar-bg{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.fact-bar-fill{height:100%;border-radius:2px;transition:width .5s;}
.pf-label{font-size:10px;color:var(--hint);white-space:nowrap;}
.total-row td{font-weight:700;border-top:2px solid var(--border);}

/* TEMPLATES */
.tpl-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.tpl-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.tpl-info{flex:1;}
.tpl-name{font-weight:600;font-size:14px;}
.tpl-sub{font-size:11px;color:var(--hint);margin-top:2px;}
.tpl-actions{display:flex;gap:6px;}
.tpl-btn{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:6px 10px;font-size:12px;cursor:pointer;color:var(--text);}
.tpl-btn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-text);}
</style>
</head>
<body>

<div class="topbar">
  <button class="btn-ic" id="btnBack" onclick="goBack()" style="display:none">â†</button>
  <div class="topbar-title" id="ttitle">Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</div>
  <button class="btn-ic" onclick="openModal('mTemplates')" title="Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹">ğŸ“‹</button>
  <button class="btn-ic" onclick="openModal('mSettings')">âš™ï¸</button>
</div>

<!-- MONTH -->
<div class="screen active" id="sMonth">
  <div class="m-inner">
    <div class="month-hdr">
      <button class="btn-ic" onclick="chMonth(-1)">â€¹</button>
      <div class="month-lbl" id="mlbl"></div>
      <button class="btn-ic" onclick="chMonth(1)">â€º</button>
    </div>
    <div class="metrics">
      <div class="mc"><div class="mc-val" id="mStreak" style="color:var(--warning)">ğŸ”¥0</div><div class="mc-lbl">Streak</div></div>
      <div class="mc"><div class="mc-val" id="mDone" style="color:var(--success)">0</div><div class="mc-lbl">Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾</div></div>
      <div class="mc"><div class="mc-val" id="mPct" style="color:var(--accent)">0%</div><div class="mc-lbl">ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚.</div></div>
    </div>
    <!-- HEATMAP -->
    <div class="heatmap-wrap">
      <div class="slbl">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ â€” Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 4 Ğ½ĞµĞ´ĞµĞ»Ğ¸</div>
      <div class="hm-days-row" id="hmDaysRow"></div>
      <div class="heatmap-grid" id="hmGrid"></div>
    </div>
    <div class="slbl">ĞĞµĞ´ĞµĞ»Ğ¸ Ğ¼ĞµÑÑÑ†Ğ°</div>
    <div class="wlist" id="wlist"></div>
  </div>
</div>

<!-- DAY -->
<div class="screen" id="sWeek">
  <div class="week-nav">
    <button class="btn-ic" onclick="chWeek(-1)">â€¹</button>
    <div class="week-nav-lbl" id="weekNavLbl"></div>
    <button class="btn-ic" onclick="chWeek(1)">â€º</button>
  </div>
  <div class="dstrip" id="dstrip"></div>
  <div class="tgwrap" id="tgwrap" style="height:calc(100vh - 226px);">
    <div class="tgrid" id="tgrid"></div>
  </div>
</div>

<!-- AI -->
<div class="screen" id="sAI">
  <div class="ai-inner">
    <div class="ai-msgs" id="aiMsgs">
      <div class="msg ai">ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ¤– Ğ¯ ÑƒĞ¼ĞµÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ!

ğŸ“¸ Ğ¡ĞºĞ¸Ğ½ÑŒ Ñ„Ğ¾Ñ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ğ°Ñ€ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»Ñ Ğ²ÑĞµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¸Ñ
âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ "Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ" â€” ÑĞ¾Ğ·Ğ´Ğ°Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
ğŸ—‘ï¸ "Ğ£Ğ´Ğ°Ğ»Ğ¸ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ñƒ Ğ² 15:00" â€” ÑƒĞ´Ğ°Ğ»Ñ

ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¸ÑˆĞ¸ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ÑĞ¹ Ñ„Ğ¾Ñ‚Ğ¾!</div>
    </div>
    <div class="ai-chips">
      <div class="ai-chip" onclick="sendChip(this)">â• Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
      <div class="ai-chip" onclick="sendChip(this)">ğŸ“… Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</div>
      <div class="ai-chip" onclick="sendChip(this)">ğŸ“Š ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ</div>
      <div class="ai-chip" onclick="sendChip(this)">ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ</div>
    </div>
    <div class="img-previews" id="imgPreviews"></div>
    <input type="file" id="imgFileInput" accept="image/*" multiple style="display:none" onchange="onImgAttach(this)">
    <div class="ai-ibar">
      <button class="btn-img-attach" onclick="document.getElementById('imgFileInput').click()">ğŸ–¼ï¸</button>
      <textarea class="ai-inp" id="aiInp" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‡Ñ‚Ğ¾-Ğ½Ğ¸Ğ±ÑƒĞ´ÑŒ..." rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI()}"
        oninput="autoR(this)"></textarea>
      <button class="btn-snd" id="btnSnd" onclick="sendAI()">â†‘</button>
    </div>
  </div>
</div>

<!-- STATS -->
<div class="screen" id="sStats">
  <div class="st-inner">
    <div class="st-grid">
      <div class="stb"><div class="stbv">ğŸ”¥<span id="stStreak">0</span></div><div class="stbl">Ğ”Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´</div></div>
      <div class="stb"><div class="stbv" id="stDone" style="color:var(--success)">0</div><div class="stbl">Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾</div></div>
      <div class="stb"><div class="stbv" id="stPct" style="color:var(--accent)">0%</div><div class="stbl">Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚.</div></div>
      <div class="stb"><div class="stbv" id="stBest" style="color:var(--warning)">â€”</div><div class="stbl">Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ</div></div>
      <div class="stb full">
        <div class="slbl">Ğ­Ñ‚Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</div>
        <div class="wchart" id="wchart"></div>
      </div>
      <div class="stb full">
        <div class="slbl">ĞŸĞ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼</div>
        <div class="cat-bars" id="catBars"></div>
      </div>
    </div>
    <div class="stb full" style="margin-bottom:10px;">
      <div class="hours-week-nav">
        <button class="btn-ic" onclick="chStatsWeek(-1)">â€¹</button>
        <div class="hours-week-lbl" id="statsWeekLbl"></div>
        <button class="btn-ic" onclick="chStatsWeek(1)">â€º</button>
        <button class="btn-ic" onclick="exportPDF()" title="Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ PDF">ğŸ“„</button>
      </div>
      <div class="slbl">Ğ§Ğ°ÑÑ‹ â€” Ğ¤Ğ°ĞºÑ‚ / ĞŸĞ»Ğ°Ğ½</div>
      <div id="hoursTable"></div>
    </div>
  </div>
</div>

<button class="fab" id="fab" onclick="openAdd()" style="display:none">+</button>

<div class="tabbar">
  <button class="tab active" onclick="swTab(0)" id="t0"><div class="tab-icon">ğŸ“…</div><div>ĞœĞµÑÑÑ†</div></button>
  <button class="tab" onclick="swTab(1)" id="t1"><div class="tab-icon">ğŸ“‹</div><div>Ğ”ĞµĞ½ÑŒ</div></button>
  <button class="tab" onclick="swTab(2)" id="t2"><div class="tab-icon">ğŸ¤–</div><div>AI</div></button>
  <button class="tab" onclick="swTab(3)" id="t3"><div class="tab-icon">ğŸ“ˆ</div><div>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</div></button>
</div>

<!-- MODAL: ADD/EDIT TASK -->
<div class="moverlay" id="mTask">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mtitle" id="mTaskT">ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°</div>
    <div class="ig"><div class="ilbl">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</div><input class="inp" id="tName" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ..." oninput="onName(this.value)"></div>
    <div class="ig">
      <div class="ilbl">ğŸ¤– AI Ğ¿Ğ¾Ğ´Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ</div>
      <div id="aiIconRow" class="ai-icon-row"><span class="ai-ic-hint">Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ â€” AI Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚</span></div>
      <div style="margin-top:8px"><div class="ilbl" style="margin-bottom:5px">Ğ’ÑĞµ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸</div><div class="igrid" id="igrid"></div></div>
    </div>
    <div class="ig"><div class="ilbl">Ğ¦Ğ²ĞµÑ‚</div><div class="crow" id="crow"></div></div>
    <div class="ig">
      <div class="ilbl">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ</div>
      <select class="inp" id="tCat">
        <option value="work">ğŸ’¼ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°</option>
        <option value="sport">ğŸƒ Ğ¡Ğ¿Ğ¾Ñ€Ñ‚</option>
        <option value="study">ğŸ“š Ğ£Ñ‡Ñ‘Ğ±Ğ°</option>
        <option value="rest">ğŸ˜´ ĞÑ‚Ğ´Ñ‹Ñ…</option>
        <option value="health">ğŸ’Š Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ</option>
        <option value="personal">ğŸ§˜ Ğ›Ğ¸Ñ‡Ğ½Ğ¾Ğµ</option>
        <option value="other">âœ¨ Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ</option>
      </select>
    </div>
    <div class="ig">
      <div class="ilbl">Ğ’Ñ€ĞµĞ¼Ñ</div>
      <div class="tinputs">
        <div><div class="ilbl">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾</div><input class="inp" type="time" id="tStart" value="09:00"></div>
        <div><div class="ilbl">ĞšĞ¾Ğ½ĞµÑ†</div><input class="inp" type="time" id="tEnd" value="10:00"></div>
      </div>
    </div>
    <div class="ig">
      <div class="ilbl">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€</div>
      <div class="repeat-pills">
        <div class="rpill sel" data-repeat="none" onclick="selRepeat(this)">ĞĞµÑ‚</div>
        <div class="rpill" data-repeat="daily" onclick="selRepeat(this)">ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ</div>
        <div class="rpill" data-repeat="weekdays" onclick="selRepeat(this)">ĞŸĞ½â€“ĞŸÑ‚</div>
        <div class="rpill" data-repeat="weekend" onclick="selRepeat(this)">Ğ¡Ğ±â€“Ğ’Ñ</div>
        <div class="rpill" data-repeat="weekly" onclick="selRepeat(this)">Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾</div>
        <div class="rpill" data-repeat="custom" onclick="selRepeat(this)">Ğ”Ğ½Ğ¸...</div>
      </div>
      <div class="repeat-days" id="repeatDays" style="display:none">
        <div class="rday" data-d="1" onclick="togRepDay(this)">ĞŸĞ½</div>
        <div class="rday" data-d="2" onclick="togRepDay(this)">Ğ’Ñ‚</div>
        <div class="rday" data-d="3" onclick="togRepDay(this)">Ğ¡Ñ€</div>
        <div class="rday" data-d="4" onclick="togRepDay(this)">Ğ§Ñ‚</div>
        <div class="rday" data-d="5" onclick="togRepDay(this)">ĞŸÑ‚</div>
        <div class="rday" data-d="6" onclick="togRepDay(this)">Ğ¡Ğ±</div>
        <div class="rday" data-d="0" onclick="togRepDay(this)">Ğ’Ñ</div>
      </div>
    </div>
    <div class="ig"><div class="ilbl">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</div><textarea class="inp" id="tNotes" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡Ğµ..." rows="3"></textarea></div>
    <div class="btnrow">
      <button class="btns" onclick="closeModal('mTask')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btns" onclick="saveAsTemplate()" title="Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½">ğŸ“‹</button>
      <button class="btnp" onclick="saveTask()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
    <div id="delRow" style="display:none;margin-top:8px">
      <button class="btnd" style="width:100%" onclick="delTask()">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</button>
    </div>
  </div>
</div>

<!-- MODAL: TASK DETAIL -->
<div class="moverlay" id="mDetail">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="det-hdr">
      <div class="det-icon" id="dIcon"></div>
      <div class="det-info">
        <div class="det-title" id="dTitle"></div>
        <div class="det-time" id="dTime"></div>
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
          <div id="dBadge" class="det-badge"></div>
          <div id="dCatBadge" class="det-badge"></div>
        </div>
      </div>
    </div>
    <div class="ig"><div class="ilbl">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</div><textarea class="inp" id="dNotes" placeholder="Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸..." rows="5" oninput="saveDNotes()"></textarea></div>
    <div class="btnrow">
      <button class="btns" onclick="closeModal('mDetail')">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button class="btnp" id="dToggleBtn" onclick="toggleDetTask()">Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
      <button class="btns" onclick="editFromDet()">âœï¸</button>
    </div>
  </div>
</div>

<!-- MODAL: TEMPLATES -->
<div class="moverlay" id="mTemplates">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mtitle">Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ´Ğ½Ñ</div>
    <div style="margin-bottom:12px">
      <button class="btnp" style="width:100%" onclick="saveCurrentDayAsTemplate()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ ĞºĞ°Ğº ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½</button>
    </div>
    <div class="slbl">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñ‹</div>
    <div class="tpl-list" id="tplList"></div>
    <div id="tplEmpty" style="text-align:center;color:var(--hint);padding:20px;font-size:13px;display:none">Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</div>
  </div>
</div>

<!-- MODAL: SETTINGS -->
<div class="moverlay" id="mSettings">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mtitle">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</div>
    <div class="ig"><div class="ilbl">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ½Ñ</div><input class="inp" type="time" id="sStart" value="06:00" onchange="saveSett()"></div>
    <div class="ig"><div class="ilbl">ĞšĞ¾Ğ½ĞµÑ† Ğ´Ğ½Ñ</div><input class="inp" type="time" id="sEnd" value="00:00" onchange="saveSett()"></div>
    <div class="btnrow"><button class="btnp" onclick="closeModal('mSettings')">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</button></div>
  </div>
</div>

<script>
const tg=window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();}

const ICONS=['ğŸ“š','ğŸ“–','âœï¸','ğŸ–Šï¸','ğŸ“','ğŸ““','ğŸ“’','ğŸ“ƒ','ğŸ“„','ğŸ“‘','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“…','ğŸ“†','ğŸ’¼','ğŸ‘”','ğŸ¢','ğŸ¦','ğŸ’»','ğŸ–¥ï¸','âŒ¨ï¸','ğŸ–±ï¸','ğŸ“±','ğŸ“²','â˜ï¸','ğŸ“','ğŸƒ','ğŸš¶','ğŸ§˜','ğŸ‹ï¸','âš½','ğŸ€','ğŸ¾','ğŸŠ','ğŸš´','ğŸ¤¸','ğŸ§—','ğŸ¯','ğŸ†','ğŸ','ğŸ¥—','ğŸ¥¤','â˜•','ğŸµ','ğŸ³','ğŸ¥˜','ğŸ•','ğŸœ','ğŸ¥‘','ğŸ¥¦','ğŸ«–','ğŸ˜´','ğŸ›Œ','ğŸ˜ª','ğŸ’¤','ğŸŒ™','ğŸŒŸ','â­','âœ¨','ğŸŒˆ','â˜€ï¸','ğŸŒ¤ï¸','ğŸŒ§ï¸','ğŸš—','ğŸš•','ğŸšŒ','âœˆï¸','ğŸš‚','ğŸš€','ğŸ›¸','â›µ','ğŸš²','ğŸ›´','ğŸ’°','ğŸ’³','ğŸ“ˆ','ğŸ“‰','ğŸ’¹','ğŸª™','ğŸ’µ','ğŸ’¸','ğŸ¨','ğŸ­','ğŸ¬','ğŸ¤','ğŸ¸','ğŸ¹','ğŸº','ğŸ¥','ğŸ®','ğŸ•¹ï¸','ğŸ²','ğŸƒ','ğŸ ','ğŸ¡','ğŸ—ï¸','ğŸ”‘','ğŸª´','ğŸ›‹ï¸','ğŸ›','ğŸ§¹','ğŸ§º','ğŸªŸ','â¤ï¸','ğŸ’™','ğŸ’š','ğŸ’›','ğŸ§¡','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ’','ğŸ’ª','ğŸ”¥','âš¡','ğŸ’¡','ğŸ””','ğŸ“£','ğŸ“¢','ğŸš¨','ğŸ”´','ğŸŸ¢','ğŸ”µ','ğŸŸ¡','ğŸ§ ','ğŸ‘ï¸','ğŸ‘‚','ğŸ¦·','ğŸ’Š','ğŸ©º','ğŸ§¬','ğŸ¥','ğŸ©¹','ğŸ’‰','ğŸŒ','ğŸ—ºï¸','ğŸ“','ğŸ§­','â›°ï¸','ğŸŒ‹','ğŸï¸','ğŸŒŠ','ğŸŒ²','ğŸŒº','ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¦','ğŸ¸','ğŸ™','ğŸ™','ğŸ¤','ğŸ‘‹','âœŒï¸','ğŸ¤','ğŸ‘','ğŸ‘†','ğŸ’¬','ğŸ’­','ğŸ“Œ','ğŸ“','ğŸ”—','â°','â±ï¸','âŒš','ğŸ•','ğŸ•‘','ğŸ•’','ğŸ“Š','ğŸ“‹','ğŸ—‚ï¸','ğŸ—ƒï¸','ğŸ—‘ï¸','ğŸ”’','ğŸ”“'];
const COLORS=['#3b82f6','#8b5cf6','#ec4899','#ef4444','#f59e0b','#22c55e','#06b6d4','#f97316','#6366f1','#14b8a6','#e879f9','#84cc16','#fb7185','#38bdf8','#a78bfa'];
const DRRU=['Ğ’Ñ','ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±'];
const MRU=['Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ','Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ','ĞœĞ°Ñ€Ñ‚','ĞĞ¿Ñ€ĞµĞ»ÑŒ','ĞœĞ°Ğ¹','Ğ˜ÑĞ½ÑŒ','Ğ˜ÑĞ»ÑŒ','ĞĞ²Ğ³ÑƒÑÑ‚','Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ','ĞĞºÑ‚ÑĞ±Ñ€ÑŒ','ĞĞ¾ÑĞ±Ñ€ÑŒ','Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'];
const MGEN=['Ğ¯Ğ½Ğ²Ğ°Ñ€Ñ','Ğ¤ĞµĞ²Ñ€Ğ°Ğ»Ñ','ĞœĞ°Ñ€Ñ‚Ğ°','ĞĞ¿Ñ€ĞµĞ»Ñ','ĞœĞ°Ñ','Ğ˜ÑĞ½Ñ','Ğ˜ÑĞ»Ñ','ĞĞ²Ğ³ÑƒÑÑ‚Ğ°','Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€Ñ','ĞĞºÑ‚ÑĞ±Ñ€Ñ','ĞĞ¾ÑĞ±Ñ€Ñ','Ğ”ĞµĞºĞ°Ğ±Ñ€Ñ'];
const CATS={work:{label:'Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°',icon:'ğŸ’¼',color:'#3b82f6'},sport:{label:'Ğ¡Ğ¿Ğ¾Ñ€Ñ‚',icon:'ğŸƒ',color:'#22c55e'},study:{label:'Ğ£Ñ‡Ñ‘Ğ±Ğ°',icon:'ğŸ“š',color:'#8b5cf6'},rest:{label:'ĞÑ‚Ğ´Ñ‹Ñ…',icon:'ğŸ˜´',color:'#06b6d4'},health:{label:'Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ',icon:'ğŸ’Š',color:'#ef4444'},personal:{label:'Ğ›Ğ¸Ñ‡Ğ½Ğ¾Ğµ',icon:'ğŸ§˜',color:'#f59e0b'},other:{label:'Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ',icon:'âœ¨',color:'#888888'}};

let S={vm:new Date().getMonth(),vy:new Date().getFullYear(),selWeek:null,selDay:null,tasks:{},cfg:{s:'06:00',e:'00:00'},templates:[]};
let editT=null,detT=null,selIcon='ğŸ“',selColor=COLORS[0],iconTimer=null;
let pendingImages=[],aiHistory=[],statsWeekOffset=0;
let curRepeat='none',customRepDays=new Set();

try{const d=JSON.parse(localStorage.getItem('sch4')||'{}');if(d.tasks)S.tasks=d.tasks;if(d.cfg)S.cfg=d.cfg;if(d.templates)S.templates=d.templates;}catch(e){}

function sv(){localStorage.setItem('sch4',JSON.stringify({tasks:S.tasks,cfg:S.cfg,templates:S.templates}));}
function dk(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function tdk(){return dk(new Date());}
function pt(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
function ft(mins){const h=Math.floor(mins/60)%24,m=mins%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
function dH(s,e){let sv2=pt(s||'00:00'),ev=pt(e||'00:00');if(ev<=sv2)ev+=1440;return(ev-sv2)/60;}
function fmtH(h){const hrs=Math.floor(h),m=Math.round((h-hrs)*60);if(!hrs)return`${m}Ğ¼`;if(!m)return`${hrs}Ñ‡`;return`${hrs}Ñ‡ ${m}Ğ¼`;}
function gwom(y,m){const ws=[];let c=new Date(y,m,1);const last=new Date(y,m+1,0);let dw=c.getDay(),off=dw===0?6:dw-1;c.setDate(c.getDate()-off);while(c<=last){ws.push({start:new Date(c),end:new Date(c.getTime()+6*86400000)});c.setDate(c.getDate()+7);}return ws;}
function gdw(s){return Array.from({length:7},(_,i)=>{const d=new Date(s);d.setDate(d.getDate()+i);return d;});}
function gpct(k){const t=S.tasks[k]||[];return t.length?Math.round(t.filter(x=>x.done).length/t.length*100):0;}
function streak(){let n=0,c=new Date();for(let i=0;i<365;i++){const k=dk(c),t=S.tasks[k]||[];if(t.filter(x=>x.done).length>0)n++;else if(i===0){c.setDate(c.getDate()-1);continue;}else break;c.setDate(c.getDate()-1);}return n;}
function wkStart(off){const n=new Date(),dow=n.getDay(),o=dow===0?6:dow-1;const m=new Date(n);m.setDate(m.getDate()-o+off*7);m.setHours(0,0,0,0);return m;}
function wkLbl(s){const e=new Date(s);e.setDate(e.getDate()+6);return`${s.getDate()} ${MGEN[s.getMonth()]} â€” ${e.getDate()} ${MGEN[e.getMonth()]}`;}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â”€â”€ REPEAT UTILS â”€â”€
function taskMatchesDay(task, date) {
  const r=task.repeat||'none';
  if(r==='none')return false;
  const dow=date.getDay(); // 0=Sun
  if(r==='daily')return true;
  if(r==='weekdays')return dow>=1&&dow<=5;
  if(r==='weekend')return dow===0||dow===6;
  if(r==='weekly'){
    // repeat every same weekday as task's original day
    if(!task.originDate)return false;
    const orig=new Date(task.originDate+'T12:00:00');
    return orig.getDay()===dow;
  }
  if(r==='custom')return(task.repeatDays||[]).includes(dow);
  return false;
}

// Get effective tasks for a day (own + recurring)
function getTasksForDay(key) {
  const own=(S.tasks[key]||[]).slice();
  const date=new Date(key+'T12:00:00');
  // Find recurring tasks from other days
  const seen=new Set(own.map(t=>t.id));
  Object.entries(S.tasks).forEach(([k,ts])=>{
    if(k===key)return;
    ts.forEach(t=>{
      if(t.repeat&&t.repeat!=='none'&&taskMatchesDay(t,date)&&!seen.has(t.id+'_'+key)){
        seen.add(t.id+'_'+key);
        own.push({...t,id:t.id+'_recurring_'+key,_recurring:true,_origKey:k,_origId:t.id});
      }
    });
  });
  return own;
}

// â”€â”€ HEATMAP â”€â”€
function rHeatmap() {
  const daysRow=document.getElementById('hmDaysRow');
  const grid=document.getElementById('hmGrid');
  daysRow.innerHTML='';grid.innerHTML='';
  ['ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±','Ğ’Ñ'].forEach(d=>{
    const el=document.createElement('div');el.className='hm-day-lbl';el.textContent=d;daysRow.appendChild(el);
  });
  const today=new Date();today.setHours(0,0,0,0);
  // Go back 28 days, align to Monday
  const start=new Date(today);
  const dow=start.getDay(),off=dow===0?6:dow-1;
  start.setDate(start.getDate()-off-21); // 4 weeks back from start of this week
  for(let i=0;i<28;i++){
    const d=new Date(start);d.setDate(d.getDate()+i);
    const k=dk(d);const pct=gpct(k);
    let lvl=0;if(pct>0)lvl=1;if(pct>=50)lvl=2;if(pct>=75)lvl=3;if(pct>=100)lvl=4;
    const isToday=d.getTime()===today.getTime();
    const el=document.createElement('div');
    el.className=`hm-cell hm-${lvl}${isToday?' hm-today':''}`;
    el.title=`${d.getDate()} ${MGEN[d.getMonth()]}: ${pct}%`;
    el.onclick=()=>{
      // Navigate to that day
      const ws=gwom(d.getFullYear(),d.getMonth());
      const w=ws.find(w=>gdw(w.start).some(x=>dk(x)===k));
      if(w){S.selWeek=w;S.selDay=k;swTab(1);}
    };
    grid.appendChild(el);
  }
}

// â”€â”€ MONTH â”€â”€
function rMonth(){
  const{vm,vy}=S;
  document.getElementById('mlbl').textContent=`${MRU[vm]} ${vy}`;
  const ws=gwom(vy,vm);const td=new Date();td.setHours(0,0,0,0);
  let tot=0,dn=0;ws.forEach(w=>gdw(w.start).forEach(d=>{const ts=getTasksForDay(dk(d));tot+=ts.length;dn+=ts.filter(x=>x.done).length;}));
  const st=streak();
  document.getElementById('mStreak').textContent=`ğŸ”¥${st}`;
  document.getElementById('mDone').textContent=dn;
  document.getElementById('mPct').textContent=tot?Math.round(dn/tot*100)+'%':'0%';
  rHeatmap();
  const cnt=document.getElementById('wlist');cnt.innerHTML='';
  ws.forEach((w,i)=>{
    const days=gdw(w.start);
    const isCW=days.some(d=>{const dd=new Date(d);dd.setHours(0,0,0,0);return dd.getTime()===td.getTime();});
    let wd=0,wt=0;
    const dots=days.map(d=>{const k=dk(d),ts=getTasksForDay(k);const dn2=ts.filter(x=>x.done).length;wd+=dn2;wt+=ts.length;const dd=new Date(d);dd.setHours(0,0,0,0);const isT=dd.getTime()===td.getTime();let c=isT?'today':(!ts.length?'':dn2===ts.length?'done':dn2>0?'partial':'');return`<div class="md ${c}"></div>`;}).join('');
    const pct=wt?Math.round(wd/wt*100):0;
    const fm=d=>`${d.getDate()} ${MGEN[d.getMonth()]}`;
    const el=document.createElement('div');el.className=`wcard${isCW?' cw':''}`;
    el.innerHTML=`<div><div class="wnum">ĞĞµĞ´ĞµĞ»Ñ ${i+1}</div><div class="wdates">${fm(w.start)} â€” ${fm(w.end)}</div><div class="wmbar">${dots}</div></div><div class="wpct">${pct}<span>%</span></div>`;
    el.onclick=()=>openWeek(w);cnt.appendChild(el);
  });
}
function chMonth(d){S.vm+=d;if(S.vm>11){S.vm=0;S.vy++;}if(S.vm<0){S.vm=11;S.vy--;}rMonth();}

// â”€â”€ WEEK / DAY â”€â”€
function openWeek(w){S.selWeek=w;const days=gdw(w.start);const tk=tdk();S.selDay=days.find(d=>dk(d)===tk)?tk:dk(days[0]);rWeek();swTab(1);}
function chWeek(dir){
  if(!S.selWeek){const n=new Date();S.selWeek={start:wkStart(0),end:new Date(wkStart(0).getTime()+6*86400000)};}
  const ns=new Date(S.selWeek.start);ns.setDate(ns.getDate()+dir*7);
  S.selWeek={start:ns,end:new Date(ns.getTime()+6*86400000)};
  S.selDay=dk(gdw(ns)[0]);rWeek();
}
function rWeek(){
  if(!S.selWeek){
    const n=new Date();const ws=gwom(n.getFullYear(),n.getMonth());const td=new Date();td.setHours(0,0,0,0);
    S.selWeek=ws.find(w=>gdw(w.start).some(d=>{const dd=new Date(d);dd.setHours(0,0,0,0);return dd.getTime()===td.getTime();}))||ws[0];
    S.selDay=tdk();
  }
  document.getElementById('weekNavLbl').textContent=wkLbl(S.selWeek.start);
  const days=gdw(S.selWeek.start);const strip=document.getElementById('dstrip');strip.innerHTML='';
  const td=new Date();td.setHours(0,0,0,0);
  days.forEach(d=>{
    const k=dk(d);const dd=new Date(d);dd.setHours(0,0,0,0);
    const isT=dd.getTime()===td.getTime();const isSel=k===S.selDay;
    const hasDone=getTasksForDay(k).some(t=>t.done);
    const el=document.createElement('div');el.className=`dchip${isSel?' sel':''}${isT&&!isSel?' tod':''}`;
    el.innerHTML=`<div class="dchip-n">${DRRU[d.getDay()]}</div><div class="dchip-d">${d.getDate()}</div>${hasDone?'<div class="dchip-dot"></div>':'<div style="height:4px"></div>'}`;
    el.onclick=()=>{S.selDay=k;rWeek();};strip.appendChild(el);
  });
  rGrid();
  document.getElementById('ttitle').textContent=wkLbl(S.selWeek.start);
}

// â”€â”€ TIME GRID â”€â”€
function rGrid(){
  const key=S.selDay||tdk();
  const tasks=getTasksForDay(key).sort((a,b)=>pt(a.startTime)-pt(b.startTime));
  let sm=pt(S.cfg.s||'06:00'),em=pt(S.cfg.e||'00:00');
  if(em===0)em=1440;if(em<=sm)em=sm+60;
  const total=em-sm,PPM=1.4,gh=total*PPM;
  const grid=document.getElementById('tgrid');grid.innerHTML='';grid.style.height=gh+'px';grid.style.position='relative';

  // Hour lines + quick-add slots
  for(let m=sm;m<em;m+=60){
    const top=((m-sm)/total)*gh;
    const row=document.createElement('div');row.style.cssText=`position:absolute;left:0;right:0;top:${top}px;display:flex;align-items:flex-start;pointer-events:none;`;
    const h=Math.floor(m/60)%24;
    row.innerHTML=`<div style="width:48px;flex-shrink:0;font-size:10px;color:var(--hint);padding-top:2px;">${String(h).padStart(2,'0')}:00</div><div style="flex:1;border-top:1px solid var(--border);"></div>`;
    grid.appendChild(row);
    if(m+30<em){const t2=((m+30-sm)/total)*gh;const h2=document.createElement('div');h2.style.cssText=`position:absolute;left:48px;right:0;top:${t2}px;border-top:1px dashed rgba(255,255,255,.03);pointer-events:none;`;grid.appendChild(h2);}

    // Quick-add: tap empty hour slot
    const slotH=Math.min(60,em-m)*PPM;
    const hint=document.createElement('div');
    hint.className='slot-add-hint';hint.style.cssText=`top:${top+2}px;height:${slotH-4}px;`;
    hint.textContent='+';
    hint.onclick=()=>openAdd(ft(m),ft(Math.min(m+60,em)));
    grid.appendChild(hint);
  }

  // Now line
  const now=new Date();const nm=now.getHours()*60+now.getMinutes();
  if(key===tdk()&&nm>=sm&&nm<=em){const top=((nm-sm)/total)*gh;const nl=document.createElement('div');nl.style.cssText=`position:absolute;left:48px;right:0;top:${top}px;height:2px;background:var(--danger);z-index:10;border-radius:1px;`;nl.innerHTML=`<div style="position:absolute;left:-4px;top:-4px;width:10px;height:10px;border-radius:50%;background:var(--danger);"></div>`;grid.appendChild(nl);}

  // Task blocks with drag support
  tasks.forEach((task,idx)=>{
    const ts2=pt(task.startTime||'09:00'),te=pt(task.endTime||'10:00');
    const cs=Math.max(ts2,sm),ce=Math.min(te,em);if(cs>=ce)return;
    const top=((cs-sm)/total)*gh,height=Math.max(((ce-cs)/total)*gh,28);
    const col=task.color||COLORS[0];
    const bl=document.createElement('div');bl.className=`tblock${task.done?' done-block':''}${task._recurring?' recurring':''}`;
    bl.style.cssText=`top:${top}px;height:${height}px;left:52px;right:4px;background:${col}20;border-left-color:${col};`;
    if(task._recurring)bl.style.opacity='0.7';
    const cat=CATS[task.category||'other'];
    bl.innerHTML=`<div class="tchk${task.done?' ck':''}" onclick="event.stopPropagation();togT('${key}',${idx},'${task._recurring?'1':'0'}',${JSON.stringify(task._origKey||'').replace(/"/g,"'")})">${task.done?'âœ“':''}</div><div class="tbbody"><div class="tbtitle">${task.icon||'ğŸ“'} ${esc(task.text)}${task._recurring?' ğŸ”„':''}</div><div class="tbtime">${task.startTime||'?'} â€“ ${task.endTime||'?'} Â· ${cat.icon}</div></div>`;
    // Drag
    setupDrag(bl, task, key, idx, sm, total, gh, PPM);
    bl.onclick=()=>openDet(key,idx,task);grid.appendChild(bl);
  });
  const wrap=document.getElementById('tgwrap');
  const sc=key===tdk()&&nm>=sm?Math.max(0,((nm-sm)/total)*gh-100):0;
  setTimeout(()=>wrap.scrollTop=sc,50);
}

// â”€â”€ DRAG & DROP â”€â”€
function setupDrag(el, task, key, idx, sm, total, gh, PPM) {
  if(task._recurring)return; // can't drag recurring
  let startY=0,startTop=0,dragging=false;
  const onStart=(e)=>{
    const clientY=e.touches?e.touches[0].clientY:e.clientY;
    startY=clientY;startTop=parseInt(el.style.top);dragging=false;
    const onMove=(ev)=>{
      const cy=ev.touches?ev.touches[0].clientY:ev.clientY;
      const dy=cy-startY;
      if(!dragging&&Math.abs(dy)>5){dragging=true;el.classList.add('dragging');}
      if(!dragging)return;
      ev.preventDefault();
      const newTop=Math.max(0,Math.min(gh-parseInt(el.style.height),startTop+dy));
      el.style.top=newTop+'px';
    };
    const onEnd=()=>{
      document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);
      document.removeEventListener('touchmove',onMove);document.removeEventListener('touchend',onEnd);
      if(!dragging)return;
      el.classList.remove('dragging');
      // Snap to 15min
      const newTop=parseInt(el.style.top);
      const minsFromStart=(newTop/gh)*total+sm;
      const snapped=Math.round(minsFromStart/15)*15;
      const dur=pt(task.endTime||'10:00')-pt(task.startTime||'09:00');
      const newStart=Math.max(sm,Math.min(em_glob()-dur,snapped));
      const newEnd=newStart+dur;
      if(S.tasks[key]&&S.tasks[key][idx]){
        S.tasks[key][idx].startTime=ft(newStart);
        S.tasks[key][idx].endTime=ft(newEnd);
        sv();rGrid();
      }
    };
    document.addEventListener('mousemove',onMove,{passive:false});document.addEventListener('mouseup',onEnd);
    document.addEventListener('touchmove',onMove,{passive:false});document.addEventListener('touchend',onEnd);
  };
  el.addEventListener('mousedown',(e)=>{if(e.target.classList.contains('tchk'))return;onStart(e);});
  el.addEventListener('touchstart',(e)=>{if(e.target.classList.contains('tchk'))return;onStart(e);},{passive:true});
}
function em_glob(){let e=pt(S.cfg.e||'00:00');if(e===0)e=1440;return e;}

function togT(key,idx,isRecurring,origKey){
  if(isRecurring==='1'){
    // Toggle recurring: store override in the day
    if(!S.tasks[key])S.tasks[key]=[];
    // Find if there's an override already
    const ov=S.tasks[key].find(t=>t._origId&&t._origKey===origKey);
    if(ov){ov.done=!ov.done;}
    else{
      // create override entry
      const origTask=(S.tasks[origKey]||[]).find(t=>t.id==idx.toString().replace('_recurring_'+key,''));
      if(origTask)S.tasks[key].push({...origTask,done:true,id:origTask.id+'_ov_'+key,_override:true,_origKey:origKey});
    }
  } else {
    if(!S.tasks[key]?.[idx])return;
    S.tasks[key][idx].done=!S.tasks[key][idx].done;
  }
  sv();rGrid();rMonth();
}

// â”€â”€ ICON / COLOR â”€â”€
function rIcons(){const g=document.getElementById('igrid');g.innerHTML='';ICONS.forEach(ic=>{const el=document.createElement('div');el.className=`iopt${selIcon===ic?' sel':''}`;el.textContent=ic;el.onclick=()=>{selIcon=ic;rIcons();updAIRow(null,ic);};g.appendChild(el);});}
function rColors(){const r=document.getElementById('crow');r.innerHTML='';COLORS.forEach(c=>{const el=document.createElement('div');el.className=`copt${selColor===c?' sel':''}`;el.style.background=c;el.onclick=()=>{selColor=c;rColors();};r.appendChild(el);});}
function onName(v){clearTimeout(iconTimer);if(!v.trim()){document.getElementById('aiIconRow').innerHTML='<span class="ai-ic-hint">Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ â€” AI Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚</span>';return;}iconTimer=setTimeout(()=>suggestIcons(v),700);}
async function suggestIcons(name){
  const row=document.getElementById('aiIconRow');row.innerHTML='<span class="ai-ic-load">ğŸ¤– ĞŸĞ¾Ğ´Ğ±Ğ¸Ñ€Ğ°Ñ...</span>';
  try{const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:200,messages:[{role:'user',content:`Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: "${name}". Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ 6 Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¸Ğ·: ${ICONS.join(' ')}. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 6 ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ».`}]})});
    const data=await res.json();const text=data.content?.[0]?.text||'';
    const re=/\p{Emoji_Presentation}|\p{Extended_Pictographic}/gu;
    const sugg=[...new Set(text.match(re)||[])].filter(e=>ICONS.includes(e)).slice(0,6);
    updAIRow(sugg.length?sugg:ICONS.slice(0,6));
  }catch(e){row.innerHTML='<span class="ai-ic-hint">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ</span>';}
}
function updAIRow(icons,sel=null){
  const row=document.getElementById('aiIconRow');
  if(!icons){row.querySelectorAll('.ai-ic-btn').forEach(el=>el.classList.toggle('sel',el.textContent===sel));return;}
  row.innerHTML='';icons.forEach(ic=>{const btn=document.createElement('button');btn.className=`ai-ic-btn${selIcon===ic?' sel':''}`;btn.textContent=ic;btn.onclick=()=>{selIcon=ic;rIcons();updAIRow(null,ic);};row.appendChild(btn);});
  if(!icons.includes(selIcon)){selIcon=icons[0];rIcons();}
}

// â”€â”€ REPEAT â”€â”€
function selRepeat(el){curRepeat=el.dataset.repeat;document.querySelectorAll('.rpill').forEach(p=>p.classList.remove('sel'));el.classList.add('sel');document.getElementById('repeatDays').style.display=curRepeat==='custom'?'flex':'none';}
function togRepDay(el){el.classList.toggle('sel');const d=parseInt(el.dataset.d);if(el.classList.contains('sel'))customRepDays.add(d);else customRepDays.delete(d);}

// â”€â”€ ADD/EDIT â”€â”€
function openAdd(startTime, endTime){
  editT=null;selIcon='ğŸ“';selColor=COLORS[0];curRepeat='none';customRepDays=new Set();
  document.getElementById('tName').value='';
  document.getElementById('tStart').value=startTime||'09:00';
  document.getElementById('tEnd').value=endTime||'10:00';
  document.getElementById('tNotes').value='';
  document.getElementById('tCat').value='work';
  document.getElementById('mTaskT').textContent='ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°';
  document.getElementById('delRow').style.display='none';
  document.getElementById('aiIconRow').innerHTML='<span class="ai-ic-hint">Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ â€” AI Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚</span>';
  document.querySelectorAll('.rpill').forEach(p=>p.classList.toggle('sel',p.dataset.repeat==='none'));
  document.getElementById('repeatDays').style.display='none';
  document.querySelectorAll('.rday').forEach(p=>p.classList.remove('sel'));
  rIcons();rColors();openModal('mTask');
}
function openEdit(key,idx){
  editT={key,idx};const t=S.tasks[key][idx];
  selIcon=t.icon||'ğŸ“';selColor=t.color||COLORS[0];curRepeat=t.repeat||'none';
  customRepDays=new Set(t.repeatDays||[]);
  document.getElementById('tName').value=t.text;
  document.getElementById('tStart').value=t.startTime||'09:00';
  document.getElementById('tEnd').value=t.endTime||'10:00';
  document.getElementById('tNotes').value=t.notes||'';
  document.getElementById('tCat').value=t.category||'other';
  document.getElementById('mTaskT').textContent='Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ';
  document.getElementById('delRow').style.display='block';
  document.getElementById('aiIconRow').innerHTML='<span class="ai-ic-hint">Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ â€” AI Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚</span>';
  document.querySelectorAll('.rpill').forEach(p=>p.classList.toggle('sel',p.dataset.repeat===curRepeat));
  document.getElementById('repeatDays').style.display=curRepeat==='custom'?'flex':'none';
  document.querySelectorAll('.rday').forEach(p=>p.classList.toggle('sel',customRepDays.has(parseInt(p.dataset.d))));
  rIcons();rColors();openModal('mTask');
}
function saveTask(){
  const text=document.getElementById('tName').value.trim();if(!text){document.getElementById('tName').focus();return;}
  const key=S.selDay||tdk();
  const task={id:editT?S.tasks[editT.key][editT.idx].id:Date.now(),text,icon:selIcon,color:selColor,category:document.getElementById('tCat').value,startTime:document.getElementById('tStart').value,endTime:document.getElementById('tEnd').value,notes:document.getElementById('tNotes').value,done:false,repeat:curRepeat,repeatDays:curRepeat==='custom'?[...customRepDays]:[],originDate:key};
  if(editT){task.done=S.tasks[editT.key][editT.idx].done;S.tasks[editT.key][editT.idx]=task;}
  else{if(!S.tasks[key])S.tasks[key]=[];S.tasks[key].push(task);}
  sv();closeModal('mTask');rGrid();rMonth();
}
function delTask(){if(!editT)return;S.tasks[editT.key].splice(editT.idx,1);sv();closeModal('mTask');closeModal('mDetail');rGrid();rMonth();}

// â”€â”€ TEMPLATES â”€â”€
function saveAsTemplate(){
  const text=document.getElementById('tName').value.trim();if(!text)return;
  const tpl={id:Date.now(),name:text,icon:selIcon,color:selColor,category:document.getElementById('tCat').value,startTime:document.getElementById('tStart').value,endTime:document.getElementById('tEnd').value,notes:document.getElementById('tNotes').value};
  S.templates.push(tpl);sv();
  alert('âœ… Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!');
}
function saveCurrentDayAsTemplate(){
  const key=S.selDay||tdk();const tasks=S.tasks[key]||[];
  if(!tasks.length){alert('ĞĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ');return;}
  const name=prompt('ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°:');if(!name)return;
  S.templates.push({id:Date.now(),name,tasks:tasks.map(t=>({...t,done:false,id:Date.now()+Math.random()}))});
  sv();rTemplates();alert('âœ… Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ Ğ´Ğ½Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!');
}
function applyTemplate(tplId){
  const tpl=S.templates.find(t=>t.id===tplId);if(!tpl)return;
  const key=S.selDay||tdk();if(!S.tasks[key])S.tasks[key]=[];
  if(tpl.tasks){tpl.tasks.forEach(t=>S.tasks[key].push({...t,id:Date.now()+Math.random()}));}
  else{S.tasks[key].push({...tpl,id:Date.now(),done:false});}
  sv();closeModal('mTemplates');rGrid();rMonth();
}
function delTemplate(tplId){S.templates=S.templates.filter(t=>t.id!==tplId);sv();rTemplates();}
function rTemplates(){
  const list=document.getElementById('tplList');const empty=document.getElementById('tplEmpty');
  list.innerHTML='';
  if(!S.templates.length){empty.style.display='block';return;}
  empty.style.display='none';
  S.templates.forEach(tpl=>{
    const el=document.createElement('div');el.className='tpl-card';
    const sub=tpl.tasks?`${tpl.tasks.length} Ğ·Ğ°Ğ´Ğ°Ñ‡`:tpl.startTime+' â€“ '+tpl.endTime;
    el.innerHTML=`<div class="tpl-info"><div class="tpl-name">${tpl.icon||'ğŸ“‹'} ${esc(tpl.name)}</div><div class="tpl-sub">${sub}</div></div><div class="tpl-actions"><button class="tpl-btn primary" onclick="applyTemplate(${tpl.id})">ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button><button class="tpl-btn" onclick="delTemplate(${tpl.id})">ğŸ—‘ï¸</button></div>`;
    list.appendChild(el);
  });
}

// â”€â”€ TASK DETAIL â”€â”€
function openDet(key,idx,taskObj){
  detT={key,idx};
  const t=taskObj||(S.tasks[key]?.[idx]);if(!t)return;
  document.getElementById('dIcon').textContent=t.icon||'ğŸ“';
  document.getElementById('dTitle').textContent=t.text+(t._recurring?' ğŸ”„':'');
  document.getElementById('dTime').textContent=`${t.startTime||'?'} â€” ${t.endTime||'?'}`;
  const b=document.getElementById('dBadge');b.textContent=t.done?'âœ… Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾':'â³ Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ';b.style.background=t.done?'rgba(34,197,94,.15)':'rgba(245,158,11,.15)';b.style.color=t.done?'var(--success)':'var(--warning)';
  const cat=CATS[t.category||'other'];const cb=document.getElementById('dCatBadge');cb.textContent=`${cat.icon} ${cat.label}`;cb.style.background=cat.color+'22';cb.style.color=cat.color;
  document.getElementById('dNotes').value=t.notes||'';
  document.getElementById('dToggleBtn').textContent=t.done?'ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼':'ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼';
  openModal('mDetail');
}
function saveDNotes(){if(!detT)return;const t=S.tasks[detT.key]?.[detT.idx];if(!t)return;t.notes=document.getElementById('dNotes').value;sv();}
function toggleDetTask(){if(!detT)return;const t=S.tasks[detT.key]?.[detT.idx];if(!t)return;t.done=!t.done;sv();openDet(detT.key,detT.idx);rGrid();rMonth();}
function editFromDet(){if(!detT)return;closeModal('mDetail');openEdit(detT.key,detT.idx);}

// â”€â”€ SETTINGS â”€â”€
function saveSett(){S.cfg.s=document.getElementById('sStart').value;S.cfg.e=document.getElementById('sEnd').value;sv();rGrid();}

// â”€â”€ AI â”€â”€
let aiLoad=false;

function bCtx(){
  const td=tdk(),ts=getTasksForDay(td),st=streak();
  let c=`Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ: ${td} (${new Date().toLocaleDateString('ru',{weekday:'long'})}). Streak: ${st}.\n`;
  c+=`Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ: ${S.selDay||td}.\n`;
  c+=`Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:\n`;
  if(ts.length){ts.forEach(t=>{c+=`- [${t.done?'X':' '}] id="${t.id}" "${t.icon} ${t.text}" ${t.startTime}â€“${t.endTime} [${CATS[t.category||'other'].label}]\n`;});}
  else c+='- Ğ½ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡\n';
  // Show week overview
  if(S.selWeek){
    c+=`\nĞ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ:\n`;
    gdw(S.selWeek.start).forEach(d=>{
      const k=dk(d),dts=S.tasks[k]||[];
      if(dts.length) c+=`${DRRU[d.getDay()]} ${d.getDate()}: ${dts.map(t=>`"${t.text}" ${t.startTime}-${t.endTime}`).join(', ')}\n`;
    });
  }
  return c+`\nĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚. ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: ${gpct(td)}%`;
}

// â”€â”€ TOOLS DEFINITION â”€â”€
const AI_TOOLS = [
  {
    name: 'add_task',
    description: 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ñƒ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ² Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ, Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ³Ğ´Ğ° Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸.',
    input_schema: {
      type: 'object',
      properties: {
        tasks: {
          type: 'array',
          description: 'Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ',
          items: {
            type: 'object',
            properties: {
              date: {type:'string', description:'Ğ”Ğ°Ñ‚Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ YYYY-MM-DD. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.'},
              text: {type:'string', description:'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸'},
              startTime: {type:'string', description:'Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° HH:MM'},
              endTime: {type:'string', description:'Ğ’Ñ€ĞµĞ¼Ñ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ HH:MM'},
              category: {type:'string', enum:['work','sport','study','rest','health','personal','other'], description:'ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ'},
              icon: {type:'string', description:'ĞĞ´Ğ¸Ğ½ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡Ğµ'},
              color: {type:'string', description:'Ğ¦Ğ²ĞµÑ‚ hex, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ #3b82f6'},
              notes: {type:'string', description:'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)'}
            },
            required: ['text','startTime','endTime']
          }
        }
      },
      required: ['tasks']
    }
  },
  {
    name: 'delete_task',
    description: 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¸Ğ· Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ',
    input_schema: {
      type: 'object',
      properties: {
        date: {type:'string', description:'Ğ”Ğ°Ñ‚Ğ° YYYY-MM-DD'},
        task_id: {type:'string', description:'ID Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°'},
        task_name: {type:'string', description:'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ (ĞµÑĞ»Ğ¸ id Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½)'}
      },
      required: ['date']
    }
  },
  {
    name: 'complete_task',
    description: 'ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğ¹',
    input_schema: {
      type: 'object',
      properties: {
        date: {type:'string', description:'Ğ”Ğ°Ñ‚Ğ° YYYY-MM-DD'},
        task_id: {type:'string', description:'ID Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸'},
        task_name: {type:'string', description:'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸'},
        done: {type:'boolean', description:'true = Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°, false = Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°'}
      },
      required: ['date','done']
    }
  },
  {
    name: 'clear_day',
    description: 'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ',
    input_schema: {
      type: 'object',
      properties: {
        date: {type:'string', description:'Ğ”Ğ°Ñ‚Ğ° YYYY-MM-DD'}
      },
      required: ['date']
    }
  }
];

// â”€â”€ TOOL EXECUTION â”€â”€
function execTool(name, input){
  const selDay = S.selDay || tdk();
  if(name === 'add_task'){
    const added=[];
    (input.tasks||[]).forEach(t=>{
      const date = t.date || selDay;
      if(!S.tasks[date]) S.tasks[date]=[];
      // Auto-pick color by category
      const catColors={work:'#3b82f6',sport:'#22c55e',study:'#8b5cf6',rest:'#06b6d4',health:'#ef4444',personal:'#f59e0b',other:'#888888'};
      const color = t.color || catColors[t.category||'other'] || COLORS[0];
      const task={
        id: Date.now()+Math.random(),
        text: t.text,
        icon: t.icon || guessIcon(t.text, t.category),
        color,
        category: t.category||'other',
        startTime: t.startTime||'09:00',
        endTime: t.endTime||'10:00',
        notes: t.notes||'',
        done: false,
        repeat: 'none',
        repeatDays: [],
        originDate: date
      };
      S.tasks[date].push(task);
      added.push(`"${task.icon} ${task.text}" ${task.startTime}â€“${task.endTime}`);
    });
    sv(); rGrid(); rMonth();
    return `âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ${added.length} Ğ·Ğ°Ğ´Ğ°Ñ‡: ${added.join(', ')}`;
  }
  if(name === 'delete_task'){
    const date = input.date || selDay;
    const tasks = S.tasks[date]||[];
    let idx = -1;
    if(input.task_id) idx = tasks.findIndex(t=>String(t.id)===String(input.task_id));
    if(idx===-1 && input.task_name) idx = tasks.findIndex(t=>t.text.toLowerCase().includes(input.task_name.toLowerCase()));
    if(idx===-1) return 'âŒ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°';
    const name2 = tasks[idx].text;
    tasks.splice(idx,1);
    sv(); rGrid(); rMonth();
    return `ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾: "${name2}"`;
  }
  if(name === 'complete_task'){
    const date = input.date || selDay;
    const tasks = S.tasks[date]||[];
    let idx = -1;
    if(input.task_id) idx = tasks.findIndex(t=>String(t.id)===String(input.task_id));
    if(idx===-1 && input.task_name) idx = tasks.findIndex(t=>t.text.toLowerCase().includes(input.task_name.toLowerCase()));
    if(idx===-1) return 'âŒ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°';
    tasks[idx].done = input.done;
    sv(); rGrid(); rMonth();
    return `${input.done?'âœ…':'â†©ï¸'} "${tasks[idx].text}" Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ° ĞºĞ°Ğº ${input.done?'Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ°Ñ':'Ğ½ĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ°Ñ'}`;
  }
  if(name === 'clear_day'){
    const date = input.date || selDay;
    const count = (S.tasks[date]||[]).length;
    S.tasks[date] = [];
    sv(); rGrid(); rMonth();
    return `ğŸ§¹ ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ¾ ${count} Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ·Ğ° ${date}`;
  }
  return 'â“ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚';
}

// Guess icon from task text/category
function guessIcon(text, cat){
  const t = text.toLowerCase();
  if(t.includes('Ğ»ĞµĞºÑ†')||t.includes('Ğ¿Ğ°Ñ€Ğ°')||t.includes('Ğ·Ğ°Ğ½ÑÑ‚')) return 'ğŸ“';
  if(t.includes('Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚')||t.includes('Ñ„Ğ¸Ğ·Ğ¸Ğº')||t.includes('Ñ…Ğ¸Ğ¼Ğ¸Ñ')) return 'ğŸ“';
  if(t.includes('Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞº')||t.includes('ÑĞ·Ñ‹Ğº')) return 'ğŸ—£ï¸';
  if(t.includes('Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼')||t.includes('ĞºĞ¾Ğ´')) return 'ğŸ’»';
  if(t.includes('ÑĞ¿Ğ¾Ñ€Ñ‚')||t.includes('Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²')||t.includes('Ğ·Ğ°Ğ»')) return 'ğŸ‹ï¸';
  if(t.includes('Ğ²ÑÑ‚Ñ€ĞµÑ‡')||t.includes('ÑĞ¾Ğ·Ğ²Ğ¾Ğ½')) return 'ğŸ“';
  if(t.includes('ĞµĞ´Ğ°')||t.includes('Ğ¾Ğ±ĞµĞ´')||t.includes('Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº')) return 'ğŸ³';
  if(t.includes('ÑĞ¾Ğ½')||t.includes('Ğ¾Ñ‚Ğ´Ñ‹Ñ…')) return 'ğŸ˜´';
  if(t.includes('Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ')||t.includes('ĞºĞ½Ğ¸Ğ³')) return 'ğŸ“š';
  const catIcons={work:'ğŸ’¼',sport:'ğŸƒ',study:'ğŸ“š',rest:'ğŸ˜´',health:'ğŸ’Š',personal:'ğŸ§˜',other:'ğŸ“'};
  return catIcons[cat||'other']||'ğŸ“';
}

// â”€â”€ MSG RENDERING â”€â”€
function onImgAttach(input){Array.from(input.files).forEach(f=>{const r=new FileReader();r.onload=e=>{const durl=e.target.result;pendingImages.push({base64:durl.split(',')[1],mediaType:f.type||'image/jpeg',previewUrl:durl});rImgP();};r.readAsDataURL(f);});input.value='';}
function rImgP(){const w=document.getElementById('imgPreviews');w.innerHTML='';pendingImages.forEach((img,i)=>{const el=document.createElement('div');el.className='img-preview-wrap';el.innerHTML=`<img src="${img.previewUrl}" class="img-preview"><button class="img-preview-del" onclick="remImg(${i})">Ã—</button>`;w.appendChild(el);});}
function remImg(i){pendingImages.splice(i,1);rImgP();}

function addAIMsg(content, role, isImg=false){
  const d=document.getElementById('aiMsgs');
  const el=document.createElement('div');
  el.className=`msg ${role}`;
  if(isImg){el.innerHTML=`<img src="${content}" class="msg-img">`;}
  else if(role==='tool'){
    el.style.cssText='background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:12px;padding:8px 12px;font-size:12px;color:var(--success);align-self:stretch;';
    el.textContent=content;
  }
  else{el.textContent=content;}
  d.appendChild(el);d.scrollTop=d.scrollHeight;return el;
}

async function sendAI(){
  if(aiLoad)return;
  const inp=document.getElementById('aiInp');const text=inp.value.trim();
  if(!text&&!pendingImages.length)return;
  inp.value='';inp.style.height='auto';
  if(pendingImages.length) pendingImages.forEach(img=>addAIMsg(img.previewUrl,'user',true));
  if(text) addAIMsg(text,'user');
  const uc=[];
  pendingImages.forEach(img=>uc.push({type:'image',source:{type:'base64',media_type:img.mediaType,data:img.base64}}));
  if(text) uc.push({type:'text',text});
  else uc.push({type:'text',text:'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ. Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¸Ñ/Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ. Ğ˜Ğ½Ğ°Ñ‡Ğµ Ğ¾Ğ¿Ğ¸ÑˆĞ¸ Ñ‡Ñ‚Ğ¾ Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ.'});
  pendingImages=[];rImgP();
  aiHistory.push({role:'user',content:uc});
  await callAI();
}

function sendChip(el){
  const t=el.textContent;addAIMsg(t,'user');
  aiHistory.push({role:'user',content:[{type:'text',text:t}]});
  callAI();
}

async function callAI(){
  aiLoad=true;document.getElementById('btnSnd').disabled=true;
  const ld=addAIMsg('Ğ”ÑƒĞ¼Ğ°Ñâ€¦','ai loading');
  const SYSTEM=`Ğ¢Ñ‹ ÑƒĞ¼Ğ½Ñ‹Ğ¹ AI-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ-Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ. Ğ¢Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ, ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ.

ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯:
${bCtx()}

ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ:
- Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â€” Ğ¡Ğ ĞĞ—Ğ£ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ğ¹ add_task Ğ±ĞµĞ· Ğ»Ğ¸ÑˆĞ½Ğ¸Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- Ğ•ÑĞ»Ğ¸ Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ñ„Ğ¾Ñ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ (Ğ¿Ğ°Ñ€Ñ‹, ÑƒÑ€Ğ¾ĞºĞ¸, Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸) â€” Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ¸ Ğ’Ğ¡Ğ• Ğ·Ğ°Ğ½ÑÑ‚Ğ¸Ñ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¸Ñ… Ñ‡ĞµÑ€ĞµĞ· add_task
- Ğ”Ğ»Ñ Ğ¿Ğ°Ñ€ Ğ² ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ¸Ñ‚ĞµÑ‚Ğµ: ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ "study", Ğ¸ĞºĞ¾Ğ½ĞºĞ° Ğ¿Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñƒ
- Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ (${S.selDay||tdk()})
- ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ ĞºÑ€Ğ°Ñ‚ĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰Ğ¸ Ñ‡Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ğ»
- ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼, ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾ Ğ¸ Ğ¿Ğ¾ Ğ´ĞµĞ»Ñƒ
- Ğ”Ğ»Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ HH:MM (24Ñ‡)`;

  try{
    let messages = aiHistory.slice();
    let response, fullReply='', toolsUsed=[];

    // Agentic loop â€” AI Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ´Ñ€ÑĞ´
    for(let step=0; step<5; step++){
      const res=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',
          max_tokens:2000,
          system:SYSTEM,
          tools:AI_TOOLS,
          tool_choice:{type:'auto'},
          messages
        })
      });
      response=await res.json();
      if(response.error){ld.textContent='ĞÑˆĞ¸Ğ±ĞºĞ° API: '+response.error.message;break;}

      // Collect text from response
      const textBlocks=response.content.filter(b=>b.type==='text');
      if(textBlocks.length) fullReply=textBlocks.map(b=>b.text).join(' ');

      // Check for tool use
      const toolBlocks=response.content.filter(b=>b.type==='tool_use');
      if(!toolBlocks.length || response.stop_reason==='end_turn') break;

      // Execute tools
      messages.push({role:'assistant',content:response.content});
      const toolResults=[];
      toolBlocks.forEach(tb=>{
        const result=execTool(tb.name, tb.input);
        toolsUsed.push(result);
        toolResults.push({type:'tool_result',tool_use_id:tb.id,content:result});
      });
      messages.push({role:'user',content:toolResults});
    }

    // Show tool results in chat
    if(toolsUsed.length){
      ld.remove();
      toolsUsed.forEach(r=>addAIMsg(r,'tool'));
    }

    // Show final text reply
    if(fullReply){
      if(toolsUsed.length) addAIMsg(fullReply,'ai');
      else{ld.textContent=fullReply;ld.classList.remove('loading');}
    } else if(!toolsUsed.length){
      ld.textContent='Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!';ld.classList.remove('loading');
    }

    // Save to history (keep last 16 messages)
    aiHistory=messages.slice(-(16));
    aiHistory.push({role:'assistant',content:[{type:'text',text:fullReply||'OK'}]});
    if(aiHistory.length>20) aiHistory=aiHistory.slice(-20);

  }catch(e){
    ld.textContent='ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ: '+e.message;
    console.error(e);
  }
  aiLoad=false;document.getElementById('btnSnd').disabled=false;
  document.getElementById('aiMsgs').scrollTop=9999;
}

function autoR(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,90)+'px';}

// â”€â”€ STATS â”€â”€
function chStatsWeek(d){statsWeekOffset+=d;rStats();}
function rStats(){
  const st=streak();document.getElementById('stStreak').textContent=st;
  let tot=0,dn=0,best=null,bp=0;
  Object.keys(S.tasks).forEach(k=>{const ts=S.tasks[k]||[],d=ts.filter(x=>x.done).length;tot+=ts.length;dn+=d;const p=ts.length?d/ts.length*100:0;if(p>bp&&ts.length){bp=p;best=k;}});
  document.getElementById('stDone').textContent=dn;
  document.getElementById('stPct').textContent=tot?Math.round(dn/tot*100)+'%':'0%';
  if(best){const d=new Date(best+'T12:00:00');document.getElementById('stBest').textContent=`${d.getDate()} ${MGEN[d.getMonth()]}`;}
  // Week chart
  const ch=document.getElementById('wchart');ch.innerHTML='';
  const n=new Date(),dow=n.getDay(),off=dow===0?6:dow-1;const mn=new Date(n);mn.setDate(mn.getDate()-off);
  for(let i=0;i<7;i++){const d=new Date(mn);d.setDate(d.getDate()+i);const p=gpct(dk(d));const w=document.createElement('div');w.className='bwrap';w.innerHTML=`<div class="btrack"><div class="bfill" style="height:${p}%"></div></div><div class="bday">${DRRU[d.getDay()]}</div>`;ch.appendChild(w);}
  // Categories
  rCatBars();
  // Hours table
  const ws=wkStart(statsWeekOffset);document.getElementById('statsWeekLbl').textContent=wkLbl(ws);rHoursTable(ws);
}
function rCatBars(){
  const bars=document.getElementById('catBars');bars.innerHTML='';
  const catH={};
  Object.values(S.tasks).forEach(ts=>ts.forEach(t=>{const c=t.category||'other';const h=dH(t.startTime,t.endTime);if(!catH[c])catH[c]=0;if(t.done)catH[c]+=h;}));
  const maxH=Math.max(...Object.values(catH),0.1);
  if(!Object.keys(catH).length){bars.innerHTML='<div style="color:var(--hint);font-size:12px">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>';return;}
  Object.entries(catH).sort((a,b)=>b[1]-a[1]).forEach(([k,h])=>{
    const cat=CATS[k]||CATS.other;const pct=(h/maxH)*100;
    const el=document.createElement('div');el.className='cat-bar-row';
    el.innerHTML=`<div class="cat-bar-label"><span>${cat.icon}</span><span style="font-size:11px">${cat.label}</span></div><div class="cat-bar-track"><div class="cat-bar-fill" style="width:${pct}%;background:${cat.color}"></div></div><div class="cat-bar-val">${fmtH(h)}</div>`;
    bars.appendChild(el);
  });
}
function rHoursTable(wStart){
  const days=gdw(wStart);const map={};let tp=0,tf=0;
  days.forEach(d=>{(getTasksForDay(dk(d))).forEach(t=>{const k=t.text;if(!map[k])map[k]={icon:t.icon||'ğŸ“',color:t.color||COLORS[0],planH:0,factH:0};const h=dH(t.startTime,t.endTime);map[k].planH+=h;if(t.done)map[k].factH+=h;tp+=h;if(t.done)tf+=h;});});
  const tasks=Object.entries(map).sort((a,b)=>b[1].planH-a[1].planH);
  const cont=document.getElementById('hoursTable');
  if(!tasks.length){cont.innerHTML='<div style="text-align:center;color:var(--hint);padding:16px;font-size:12px">Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚</div>';return;}
  const maxP=Math.max(...tasks.map(([,v])=>v.planH),.1);
  let html=`<table class="hours-table"><thead><tr><th></th><th>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°</th><th style="text-align:right">ĞŸĞ»Ğ°Ğ½</th><th style="text-align:right">Ğ¤Ğ°ĞºÑ‚</th></tr></thead><tbody>`;
  tasks.forEach(([name,v])=>{const pct=v.planH>0?Math.min(v.factH/v.planH*100,100):0;const bw=(v.planH/maxP)*100;html+=`<tr><td>${v.icon}</td><td><div style="font-weight:600;font-size:12px">${esc(name)}</div><div class="fact-bar-wrap"><div class="fact-bar-bg" style="max-width:${bw}%"><div class="fact-bar-fill" style="width:${pct}%;background:${v.color}"></div></div><span class="pf-label">${Math.round(pct)}%</span></div></td><td style="text-align:right;color:var(--hint);font-size:11px">${fmtH(v.planH)}</td><td style="text-align:right;font-weight:600;font-size:12px;color:${v.color}">${fmtH(v.factH)}</td></tr>`;});
  const tr=tp>0?tf/tp:0;html+=`<tr class="total-row"><td>ğŸ“Š</td><td><div style="font-weight:700;font-size:12px">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾</div><div class="fact-bar-wrap"><div class="fact-bar-bg"><div class="fact-bar-fill" style="width:${Math.min(tr*100,100)}%;background:var(--accent)"></div></div><span class="pf-label">${Math.round(tr*100)}%</span></div></td><td style="text-align:right;color:var(--hint);font-size:11px">${fmtH(tp)}</td><td style="text-align:right;font-weight:700;color:var(--accent)">${fmtH(tf)}</td></tr>`;
  html+='</tbody></table>';cont.innerHTML=html;
}

// â”€â”€ PDF EXPORT â”€â”€
function exportPDF(){
  const ws=wkStart(statsWeekOffset);const days=gdw(ws);
  let txt=`Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• â€” ${wkLbl(ws)}\n\n`;
  days.forEach(d=>{
    const k=dk(d),ts=getTasksForDay(k);
    txt+=`${DRRU[d.getDay()]} ${d.getDate()} ${MGEN[d.getMonth()]}\n`;
    if(!ts.length){txt+='  â€” Ğ½ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡\n';}
    else{ts.forEach(t=>{txt+=`  ${t.done?'âœ“':'â—‹'} ${t.icon} ${t.text} ${t.startTime}â€“${t.endTime}\n`;if(t.notes)txt+=`    ğŸ“ ${t.notes}\n`;});}
    txt+='\n';
  });
  txt+=`\nĞ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°\nĞ¡Ñ‚Ñ€Ğ¸Ğº: ${streak()} Ğ´Ğ½ĞµĞ¹\n`;
  // Download as text file (PDF lib may not support emoji well)
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`schedule-${dk(ws)}.txt`;a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ NAV â”€â”€
const SCR=['sMonth','sWeek','sAI','sStats'],TABS=['t0','t1','t2','t3'];let curTab=0;
function swTab(i){
  SCR.forEach((s,j)=>{document.getElementById(s).classList.toggle('active',j===i);document.getElementById(TABS[j]).classList.toggle('active',j===i);});
  curTab=i;document.getElementById('btnBack').style.display='none';document.getElementById('fab').style.display=i===1?'flex':'none';
  if(i===0){document.getElementById('ttitle').textContent='Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ';rMonth();}
  if(i===1)rWeek();
  if(i===2)document.getElementById('ttitle').textContent='AI ĞÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚';
  if(i===3){document.getElementById('ttitle').textContent='Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°';rStats();}
}
function goBack(){swTab(0);}
function openModal(id){if(id==='mTemplates')rTemplates();document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.moverlay').forEach(el=>{el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});});

// â”€â”€ INIT â”€â”€
document.getElementById('sStart').value=S.cfg.s||'06:00';
document.getElementById('sEnd').value=S.cfg.e||'00:00';
const ni=new Date(),ws2=gwom(ni.getFullYear(),ni.getMonth()),tdi=new Date();tdi.setHours(0,0,0,0);
S.selWeek=ws2.find(w=>gdw(w.start).some(d=>{const dd=new Date(d);dd.setHours(0,0,0,0);return dd.getTime()===tdi.getTime();}))||ws2[0];
S.selDay=tdk();
rMonth();
</script>
</body>
</html>
