<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AI Schedule Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f0f0f; --card:#171717; --text:#fff; --hint:#9ca3af; --accent:#3b82f6; --border:#2a2a2a;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --r:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;}
    .top{position:sticky;top:0;background:rgba(15,15,15,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--border);padding:12px 14px;z-index:10;}
    .title{font-weight:700;font-size:14px;letter-spacing:.02em;}
    .wrap{padding:14px;display:flex;flex-direction:column;gap:12px;max-width:720px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px;}
    .row{display:flex;gap:8px;align-items:center;}
    .grow{flex:1;}
    .btn{background:var(--accent);border:none;color:white;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .btn2{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;}
    .inp{width:100%;background:#0b0b0b;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;outline:none;}
    .inp:focus{border-color:var(--accent);}
    .msgs{display:flex;flex-direction:column;gap:10px;max-height:58vh;overflow:auto;padding-right:4px;}
    .msg{max-width:86%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);white-space:pre-wrap;line-height:1.45;}
    .ai{align-self:flex-start;background:#111;}
    .me{align-self:flex-end;background:rgba(59,130,246,.25);border-color:rgba(59,130,246,.35);}
    .tool{align-self:stretch;background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.25);color:var(--ok);font-size:13px;}
    .err{align-self:stretch;background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25);color:var(--bad);font-size:13px;}
    .imgRow{display:flex;gap:8px;flex-wrap:wrap;}
    .thumb{width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--border);}
    .small{font-size:12px;color:var(--hint);}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="top">
    <div class="title" id="hdr">AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
    <div class="small" id="sub"></div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="small">
        –í–∞–∂–Ω–æ: –∫–ª—é—á–µ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ—Ç. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –≤ —Ç–≤–æ–π Worker <code>/api/ai</code>.
      </div>
      <div class="small" id="who"></div>
    </div>

    <div class="card">
      <div class="msgs" id="msgs">
        <div class="msg ai">–ü—Ä–∏–≤–µ—Ç. –Ø –∂–∏–≤—É –≤ Telegram Mini App. –ü–∏—à–∏ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–π —Ñ–æ—Ç–æ (–µ—Å–ª–∏ —Ç–≤–æ–π –ø–ª–∞–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç).</div>
      </div>
    </div>

    <div class="card">
      <div class="imgRow" id="previews"></div>
      <div class="row" style="margin-top:10px;">
        <input class="inp grow" id="text" placeholder="–ù–∞–ø–∏—à–∏ –∑–∞–ø—Ä–æ—Å..." />
        <button class="btn2" id="btnImg">üñºÔ∏è</button>
        <button class="btn" id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="small" style="margin-top:8px;">
        –°–æ–≤–µ—Ç: –µ—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äú–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã‚Äù (add_task/delete_task...), –ø–æ–¥–∫–ª—é—á–∏ –∏—Ö –≤ <code>AI_TOOLS</code> –Ω–∏–∂–µ.
      </div>
    </div>
  </div>

<script>
/** =========================
 *  –ù–ê–°–¢–†–û–ô–ö–ò
 *  ========================= */
const AI_PROXY_URL = "https://YOUR-WORKER.workers.dev/api/ai"; // <-- –∑–∞–º–µ–Ω–∏
const MAX_HISTORY = 10;

/** =========================
 *  TELEGRAM INIT
 *  ========================= */
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
  try { tg.disableVerticalSwipes(); } catch(e){}
  try { tg.enableClosingConfirmation(); } catch(e){}
}

function tgInitData(){ return tg?.initData || ""; }
function tgUser(){ return tg?.initDataUnsafe?.user || null; }

const user = tgUser();
document.getElementById("who").textContent =
  user ? `–¢—ã: ${user.first_name || ""} ${user.last_name || ""} (@${user.username || "‚Äî"}) ¬∑ id=${user.id}` :
         "–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å user.id";

document.getElementById("sub").textContent =
  tg ? "Mini App –∞–∫—Ç–∏–≤–µ–Ω" : "–û—Ç–∫—Ä–æ–π –≤ Telegram (–∏–Ω–∞—á–µ initData –ø—É—Å—Ç–æ–π)";

/** =========================
 *  UI HELPERS
 *  ========================= */
const $msgs = document.getElementById("msgs");
const $text = document.getElementById("text");
const $btnSend = document.getElementById("btnSend");
const $btnImg = document.getElementById("btnImg");
const $previews = document.getElementById("previews");

function addMsg(text, cls="ai"){
  const el = document.createElement("div");
  el.className = `msg ${cls}`;
  el.textContent = text;
  $msgs.appendChild(el);
  $msgs.scrollTop = $msgs.scrollHeight;
  return el;
}
function addErr(text){ return addMsg(text, "err"); }
function addTool(text){ return addMsg(text, "tool"); }

function addImgPreview(dataUrl){
  const img = document.createElement("img");
  img.src = dataUrl;
  img.className = "thumb";
  $previews.appendChild(img);
}

let pendingImages = []; // {base64, mediaType, previewUrl}
let history = [];       // Anthropic messages array: [{role, content:[...]}]

/** =========================
 *  (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û) TOOLS
 *  =========================
 *  –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø–æ–¥–∫–ª—é—á–∏ —Ç–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
 *  –°–µ–π—á–∞—Å —ç—Ç–æ ‚Äú—Å–∫–µ–ª–µ—Ç‚Äù, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∫–æ–¥.
 */
const AI_TOOLS = [
  {
    name: "reply",
    description: "Reply to the user with a Russian text message",
    input_schema: {
      type: "object",
      properties: { message: { type:"string" } },
      required: ["message"]
    }
  },
];

function execTool(name, input){
  if (name === "reply") return { type: "reply", text: input.message || "" };
  return { type: "error", text: "Unknown tool: " + name };
}

/** =========================
 *  FILE PICKER
 *  ========================= */
const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.accept = "image/*";
fileInput.multiple = true;
fileInput.style.display = "none";
document.body.appendChild(fileInput);

$btnImg.onclick = () => fileInput.click();

fileInput.onchange = () => {
  const files = Array.from(fileInput.files || []);
  for (const f of files) {
    const r = new FileReader();
    r.onload = (e) => {
      const dataUrl = e.target.result;
      const base64 = String(dataUrl).split(",")[1] || "";
      pendingImages.push({
        base64,
        mediaType: f.type || "image/jpeg",
        previewUrl: dataUrl
      });
      addImgPreview(dataUrl);
    };
    r.readAsDataURL(f);
  }
  fileInput.value = "";
};

/** =========================
 *  CALL PROXY
 *  ========================= */
function buildUserContent(text){
  const blocks = [];
  for (const img of pendingImages) {
    blocks.push({
      type: "image",
      source: { type:"base64", media_type: img.mediaType, data: img.base64 }
    });
  }
  if (text && text.trim()) blocks.push({ type:"text", text: text.trim() });
  if (!blocks.length) blocks.push({ type:"text", text: "–ü—Ä–∏–≤–µ—Ç" });
  return blocks;
}

function trimHistory(){
  if (history.length > MAX_HISTORY) history = history.slice(-MAX_HISTORY);
}

async function proxyCall(payload){
  const res = await fetch(AI_PROXY_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      initData: tgInitData(),
      payload
    })
  });

  const raw = await res.text().catch(()=> "");
  let data = null;
  try { data = JSON.parse(raw); } catch(e) {}

  if (!res.ok) {
    const msg = data?.error ? `${data.error}${data.hint ? " ‚Äî " + data.hint : ""}` :
                              `HTTP ${res.status}: ${raw.slice(0,160)}`;
    throw new Error(msg);
  }
  return data;
}

/** =========================
 *  SEND
 *  ========================= */
$btnSend.onclick = send;
$text.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
});

async function send(){
  const text = $text.value.trim();
  if (!text && !pendingImages.length) return;

  if (pendingImages.length) addMsg("üìé –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " + pendingImages.length, "me");
  if (text) addMsg(text, "me");
  $text.value = "";

  const userContent = buildUserContent(text);

  history.push({ role:"user", content: userContent });
  trimHistory();

  const loading = addMsg("–î—É–º–∞—é‚Ä¶", "ai");

  try {
    // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å tool-use: –¥–æ–±–∞–≤—å tools+system —Å—é–¥–∞ –∏ –≤–∫–ª—é—á–∏ loop.
    const payload = {
      // model/max_tokens —Å–µ—Ä–≤–µ—Ä –∑–∞–¥–∞—Å—Ç —Å–∞–º –ø–æ —Ç–∞—Ä–∏—Ñ—É
      max_tokens: 1024,
      messages: history
    };

    const resp = await proxyCall(payload);

    // Anthropic response: resp.content is array of blocks
    const blocks = resp.content || [];
    const textOut = blocks.filter(b => b.type === "text").map(b => b.text).join("\n").trim();

    loading.remove();

    if (!textOut) {
      addMsg("–ì–æ—Ç–æ–≤–æ.", "ai");
    } else {
      addMsg(textOut, "ai");
    }

    history.push({ role:"assistant", content: blocks });
    trimHistory();

  } catch (e) {
    loading.remove();
    addErr("‚ö†Ô∏è " + e.message);
  } finally {
    pendingImages = [];
    $previews.innerHTML = "";
    $msgs.scrollTop = $msgs.scrollHeight;
  }
}
</script>
</body>
</html>
